<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pinuslo Apps - Management System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDK v9 (Modular) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, query, where, orderBy, limit, getDocs, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyAEyZF2Ib10UD7vv8l3nclb-KfChIczIz4",
            authDomain: "pinewater-393fe.firebaseapp.com",
            projectId: "pinewater-393fe",
            storageBucket: "pinewater-393fe.firebasestorage.app",
            messagingSenderId: "1039943692827",
            appId: "1:1039943692827:web:014dd0b891143a8a95febe",
            measurementId: "G-931M74XQQK"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            console.log('‚úÖ Firebase connected');
            window.firebaseDb = db;
            window.firebaseEnabled = true;
            window.firebaseModules = { collection, doc, setDoc, getDoc, updateDoc, query, where, orderBy, limit, getDocs, serverTimestamp };
        } catch (error) {
            console.error('‚ùå Firebase failed:', error);
            window.firebaseEnabled = false;
        }
    </script>
    
    <style>
        :root {
            --cream: #F5F5F0;
            --beige: #E6D8C3;
            --tan: #C2A68C;
            --forest: #5D866C;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, var(--cream) 0%, var(--beige) 100%); min-height: 100vh; }
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; background: linear-gradient(135deg, var(--forest) 0%, var(--tan) 100%); }
        .login-card { background: white; border-radius: 20px; padding: 2.5rem; box-shadow: 0 20px 60px rgba(93, 134, 108, 0.3); width: 100%; max-width: 420px; animation: slideIn 0.8s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
        .login-logo { width: 90px; height: 90px; background: linear-gradient(135deg, var(--forest) 0%, var(--tan) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; color: white; font-size: 2.5rem; box-shadow: 0 8px 25px rgba(93, 134, 108, 0.4); }
        .login-title { color: var(--forest); font-weight: 700; font-size: 1.8rem; text-align: center; margin-bottom: 0.5rem; }
        .login-subtitle { color: var(--tan); font-size: 0.95rem; text-align: center; margin-bottom: 2rem; }
        .login-input-container { position: relative; margin-bottom: 1.5rem; }
        .login-input { width: 100%; padding: 1rem 1rem 1rem 3rem; border: 2px solid var(--beige); border-radius: 12px; font-size: 1rem; transition: all 0.3s ease; background: var(--cream); }
        .login-input:focus { border-color: var(--forest); box-shadow: 0 0 0 0.2rem rgba(93, 134, 108, 0.25); outline: none; background: white; }
        .login-input-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--forest); font-size: 1.1rem; }
        .password-toggle { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--tan); cursor: pointer; }
        .login-btn { width: 100%; padding: 1.1rem; background: linear-gradient(135deg, var(--forest) 0%, var(--tan) 100%); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(93, 134, 108, 0.3); }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(93, 134, 108, 0.4); }
        .app-selection-container { min-height: 100vh; padding: 2rem; background: linear-gradient(135deg, var(--cream) 0%, var(--beige) 100%); }
        .user-welcome { background: white; border-radius: 15px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; max-width: 600px; margin: 0 auto 3rem; }
        .user-avatar { width: 60px; height: 60px; background: linear-gradient(135deg, var(--forest) 0%, var(--tan) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: bold; }
        .logout-btn { background: var(--tan); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-weight: 500; }
        .logout-btn:hover { background: var(--forest); transform: translateY(-2px); }
        .apps-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
        .app-card { background: white; border-radius: 20px; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; border: 3px solid transparent; }
        .app-card:hover { transform: translateY(-10px); box-shadow: 0 15px 40px rgba(0,0,0,0.15); border-color: var(--forest); }
        .app-icon { width: 80px; height: 80px; border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; font-size: 2.5rem; color: white; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .app-card.pinus { background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%); }
        .app-card.pinus .app-icon { background: linear-gradient(135deg, var(--forest) 0%, #3b7a5e 100%); }
        .app-card.pinewater { background: linear-gradient(135deg, #ffffff 0%, #ecfeff 100%); }
        .app-card.pinewater .app-icon { background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%); }
        .app-card.bbm { background: linear-gradient(135deg, #ffffff 0%, #fef3c7 100%); }
        .app-card.bbm .app-icon { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .app-card.absensi { background: linear-gradient(135deg, #ffffff 0%, #f3e8ff 100%); }
        .app-card.absensi .app-icon { background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); }
        .page-section { display: none; }
        .page-section.active { display: block; }
        .alert-custom { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; min-width: 300px; max-width: 90%; border-radius: 12px; padding: 1rem 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideDown 0.5s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateX(-50%) translateY(-20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        .alert-success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .alert-danger { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
    </style>
</head>
<body>
    <div id="loginPage" class="page-section active">
        <div class="login-container">
            <div class="login-card">
                <div class="login-logo"><i class="fas fa-rocket"></i></div>
                <h2 class="login-title">Pinuslo Apps</h2>
                <p class="login-subtitle">Unified Management Platform</p>
                <form onsubmit="return handleLogin(event)">
                    <div class="login-input-container">
                        <input type="text" class="login-input" id="username" placeholder="Username" required>
                        <div class="login-input-icon"><i class="fas fa-user"></i></div>
                    </div>
                    <div class="login-input-container">
                        <input type="password" class="login-input" id="password" placeholder="Password" required>
                        <div class="login-input-icon"><i class="fas fa-lock"></i></div>
                        <div class="password-toggle" onclick="togglePassword()"><i class="fas fa-eye" id="passwordToggleIcon"></i></div>
                    </div>
                    <button type="submit" class="login-btn"><i class="fas fa-sign-in-alt me-2"></i>Masuk</button>
                </form>
            </div>
        </div>
    </div>

    <div id="appSelectionPage" class="page-section">
        <div class="app-selection-container">
            <div class="user-welcome">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="user-avatar" id="userAvatar">Y</div>
                    <div>
                        <h3 id="userName" style="color: var(--forest); margin: 0;">Yuzar</h3>
                        <p id="userRole" style="color: var(--tan); margin: 0; font-size: 0.9rem;">Administrator</p>
                    </div>
                </div>
                <button class="logout-btn" onclick="handleLogout()"><i class="fas fa-sign-out-alt me-2"></i>Keluar</button>
            </div>
            <div style="text-align: center; margin-bottom: 3rem;">
                <h1 style="color: var(--forest); font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">Pilih Aplikasi</h1>
                <p style="color: var(--tan); font-size: 1.1rem;">Silakan pilih aplikasi yang ingin Anda gunakan</p>
            </div>
            <div class="apps-grid">
                <div class="app-card pinus" data-app="pinus">
                    <div class="app-icon"><i class="fas fa-tree"></i></div>
                    <h3 style="color: var(--forest); font-size: 1.5rem; text-align: center; margin-bottom: 0.5rem;">Pinus Selow Regist</h3>
                    <p style="color: var(--tan); text-align: center; font-size: 0.95rem;">Sistem Pendaftaran & Manajemen Pinus</p>
                </div>
                <div class="app-card pinewater" data-app="pinewater">
                    <div class="app-icon"><i class="fas fa-water"></i></div>
                    <h3 style="color: var(--forest); font-size: 1.5rem; text-align: center; margin-bottom: 0.5rem;">Pinewater</h3>
                    <p style="color: var(--tan); text-align: center; font-size: 0.95rem;">Sistem Manajemen Air & Distribusi</p>
                </div>
                <div class="app-card bbm" data-app="bbm">
                    <div class="app-icon"><i class="fas fa-gas-pump"></i></div>
                    <h3 style="color: var(--forest); font-size: 1.5rem; text-align: center; margin-bottom: 0.5rem;">BBM Management</h3>
                    <p style="color: var(--tan); text-align: center; font-size: 0.95rem;">Sistem Manajemen Bahan Bakar Minyak</p>
                </div>
                <div class="app-card absensi" data-app="absensi">
                    <div class="app-icon"><i class="fas fa-fingerprint"></i></div>
                    <h3 style="color: var(--forest); font-size: 1.5rem; text-align: center; margin-bottom: 0.5rem;">Absensi</h3>
                    <p style="color: var(--tan); text-align: center; font-size: 0.95rem;">Sistem Absensi & Kehadiran Karyawan</p>
                </div>
            </div>
        </div>
    </div>

    <div id="absensiContainer" class="page-section"></div>

    <script>
        let currentUser = null;
        const allUsers = [
            { username: 'yuzar', password: 'yuzar123', role: 'super-admin', fullName: 'Yuzar', apps: ['pinus', 'pinewater', 'bbm', 'absensi'] },
            { username: 'iqbal', password: 'iqbal123', role: 'super-admin', fullName: 'Iqbal', apps: ['pinus', 'pinewater', 'bbm', 'absensi'] },
            { username: 'agus', password: 'agus123', role: 'staff', fullName: 'Agus', apps: ['absensi'] },
            { username: 'selfi', password: 'selfi123', role: 'staff', fullName: 'Selfi', apps: ['absensi'] },
            { username: 'fadel', password: 'fadel123', role: 'staff', fullName: 'Fadel', apps: ['absensi'] },
            { username: 'farel', password: 'farel123', role: 'staff', fullName: 'Farel', apps: ['absensi'] },
            { username: 'ikki', password: 'ikki123', role: 'staff', fullName: 'Ikki', apps: ['absensi'] },
            { username: 'sadiq', password: 'sadiq123', role: 'staff', fullName: 'Sadiq', apps: ['absensi'] },
            { username: 'sirad', password: 'sirad123', role: 'staff', fullName: 'Sirad', apps: ['absensi'] },
            { username: 'bate', password: 'bate123', role: 'staff', fullName: 'Bate', apps: ['absensi'] },
            { username: 'boncel', password: 'boncel123', role: 'staff', fullName: 'Boncel', apps: ['absensi'] },
            { username: 'pian', password: 'pian123', role: 'staff', fullName: 'Pian', apps: ['absensi'] },
            { username: 'juned', password: 'juned123', role: 'staff', fullName: 'Juned', apps: ['absensi'] }
        ];

        // External app URLs
        const appUrls = {
            'pinus': 'https://pinusselowregist.netlify.app',
            'pinewater': 'https://pinewater.netlify.app',
            'bbm': 'https://bbm-management.netlify.app' // Ganti dengan URL yang sesuai
        };

        function togglePassword() {
            const input = document.getElementById('password');
            const icon = document.getElementById('passwordToggleIcon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const user = allUsers.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('pinuslo_user', JSON.stringify(user));
                showAlert('Login berhasil! Selamat datang, ' + user.fullName, 'success');
                setTimeout(() => showAppSelection(user), 1000);
            } else {
                showAlert('Username atau password salah!', 'danger');
            }
            return false;
        }

        function showAppSelection(user) {
            document.getElementById('loginPage').classList.remove('active');
            document.getElementById('appSelectionPage').classList.add('active');
            document.getElementById('userAvatar').textContent = user.fullName.charAt(0).toUpperCase();
            document.getElementById('userName').textContent = user.fullName;
            document.getElementById('userRole').textContent = user.role === 'super-admin' ? 'Super Administrator' : 'Staff';
            
            setTimeout(() => {
                document.querySelectorAll('.app-card').forEach(card => {
                    const appType = card.getAttribute('data-app');
                    if (!user.apps.includes(appType)) {
                        card.style.opacity = '0.5';
                        card.style.cursor = 'not-allowed';
                        card.onclick = () => showAlert('Anda tidak memiliki akses', 'danger');
                    } else {
                        card.onclick = () => {
                            if (appType === 'absensi') {
                                // Open internal absensi app
                                loadAbsensi(user);
                            } else if (appUrls[appType]) {
                                // Redirect to external app
                                showAlert('Membuka ' + (appType === 'pinus' ? 'Pinus Selow Regist' : appType === 'pinewater' ? 'Pinewater' : 'BBM Management') + '...', 'success');
                                setTimeout(() => {
                                    window.open(appUrls[appType], '_blank');
                                }, 500);
                            }
                        };
                    }
                });
            }, 100);
        }

        function handleLogout() {
            if (confirm('Yakin ingin keluar?')) {
                currentUser = null;
                localStorage.removeItem('pinuslo_user');
                document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
                document.getElementById('loginPage').classList.add('active');
                document.querySelector('form').reset();
                showAlert('Berhasil keluar', 'success');
            }
        }

        async function loadAbsensi(user) {
            document.getElementById('appSelectionPage').classList.remove('active');
            const container = document.getElementById('absensiContainer');
            container.classList.add('active');
            
            const today = new Date().toISOString().split('T')[0];
            const todayData = await loadData(user.username, today);
            const isIn = todayData && todayData.checkIn && !todayData.checkOut;
            const isDone = todayData && todayData.checkOut;
            
            container.innerHTML = `
                <div style="min-height: 100vh; background: linear-gradient(135deg, var(--cream) 0%, var(--beige) 100%); padding: 2rem;">
                    <div style="max-width: 1200px; margin: 0 auto;">
                        <div style="background: white; border-radius: 15px; padding: 1.5rem; margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #a855f7, #9333ea); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;"><i class="fas fa-fingerprint"></i></div>
                                <div>
                                    <h2 style="margin: 0; color: var(--forest);">Sistem Absensi</h2>
                                    <p style="margin: 0; color: var(--tan); font-size: 0.9rem;">${user.fullName} ‚Ä¢ ${window.firebaseEnabled ? 'Cloud' : 'Local'}</p>
                                </div>
                            </div>
                            <button onclick="backToSelection()" style="padding: 0.8rem 1.5rem; background: var(--tan); color: white; border: none; border-radius: 10px; cursor: pointer;"><i class="fas fa-arrow-left me-2"></i>Kembali</button>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                            <div style="background: white; border-radius: 20px; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                                <h3 style="text-align: center; color: var(--forest); margin-bottom: 1rem;"><i class="fas fa-clock me-2"></i>Absensi Hari Ini</h3>
                                <div id="clock" style="text-align: center; font-size: 3rem; font-weight: bold; color: var(--forest); margin: 2rem 0; font-family: monospace;">00:00:00</div>
                                <div id="date" style="text-align: center; font-size: 1.2rem; color: var(--tan); margin-bottom: 2rem;"></div>
                                <div style="text-align: center; margin-bottom: 2rem;">
                                    <span style="display: inline-block; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600; background: ${isDone ? 'rgba(168,85,247,0.15)' : isIn ? 'rgba(16,185,129,0.15)' : 'rgba(239,68,68,0.15)'}; color: ${isDone ? '#a855f7' : isIn ? '#059669' : '#dc2626'};">
                                        <i class="fas fa-${isDone ? 'check-circle' : isIn ? 'sign-in-alt' : 'clock'} me-2"></i>${isDone ? 'Selesai' : isIn ? 'Sudah Check In' : 'Belum Check In'}
                                    </span>
                                </div>
                                ${todayData ? `
                                    <div style="background: var(--cream); padding: 1.5rem; border-radius: 10px; margin-bottom: 1rem;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                                            <span><i class="fas fa-sign-in-alt me-2" style="color: #10b981;"></i>Check In:</span>
                                            <strong style="color: var(--forest);">${todayData.checkIn || '-'}</strong>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span><i class="fas fa-sign-out-alt me-2" style="color: #ef4444;"></i>Check Out:</span>
                                            <strong style="color: var(--forest);">${todayData.checkOut || '-'}</strong>
                                        </div>
                                        ${todayData.checkOut ? `<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--beige); text-align: center;"><span style="color: #666;">Total Jam:</span><strong style="display: block; color: var(--forest); font-size: 1.2rem; margin-top: 0.5rem;">${calcHours(todayData.checkIn, todayData.checkOut)}</strong></div>` : ''}
                                    </div>
                                ` : ''}
                                <button onclick="checkIn()" style="width: 100%; padding: 1.5rem; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 15px; font-size: 1.3rem; cursor: pointer; margin-bottom: 1rem;" ${isIn || isDone ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}><i class="fas fa-sign-in-alt me-2" style="font-size: 1.5rem;"></i>Check In</button>
                                <button onclick="checkOut()" style="width: 100%; padding: 1.5rem; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; border-radius: 15px; font-size: 1.3rem; cursor: pointer;" ${!isIn || isDone ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}><i class="fas fa-sign-out-alt me-2" style="font-size: 1.5rem;"></i>Check Out</button>
                            </div>
                            <div style="background: white; border-radius: 20px; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                                <h3 style="color: var(--forest); margin-bottom: 1.5rem;"><i class="fas fa-history me-2"></i>Riwayat Absensi</h3>
                                <div id="history" style="max-height: 500px; overflow-y: auto;"><p style="text-align: center; color: #999; padding: 2rem;">Memuat...</p></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            setInterval(() => {
                const now = new Date();
                document.getElementById('clock').textContent = now.toLocaleTimeString('id-ID');
                document.getElementById('date').textContent = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }, 1000);
            
            loadHistory(user.username);
        }

        async function loadData(username, date) {
            if (window.firebaseEnabled && window.firebaseDb) {
                try {
                    const { doc, getDoc } = window.firebaseModules;
                    const docSnap = await getDoc(doc(window.firebaseDb, 'attendance', `${username}_${date}`));
                    return docSnap.exists() ? docSnap.data() : null;
                } catch (e) { console.log('Firebase error:', e); }
            }
            const local = JSON.parse(localStorage.getItem('attendance_' + username) || '{}');
            return local[date] || null;
        }

        async function loadHistory(username) {
            let data = {};
            if (window.firebaseEnabled && window.firebaseDb) {
                try {
                    const { collection, query, where, orderBy, limit, getDocs } = window.firebaseModules;
                    const q = query(collection(window.firebaseDb, 'attendance'), where('username', '==', username), orderBy('date', 'desc'), limit(30));
                    const snap = await getDocs(q);
                    snap.forEach(doc => { const d = doc.data(); data[d.date] = d; });
                } catch (e) { console.log('Firebase error:', e); }
            }
            if (Object.keys(data).length === 0) {
                data = JSON.parse(localStorage.getItem('attendance_' + username) || '{}');
            }
            
            const html = Object.keys(data).length === 0 ? '<p style="text-align: center; color: #999; padding: 2rem;">Belum ada riwayat</p>' :
                Object.keys(data).sort().reverse().map(date => {
                    const d = data[date];
                    const dateObj = new Date(date + 'T00:00:00');
                    const formatted = dateObj.toLocaleDateString('id-ID', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
                    return `<div style="padding: 1rem; border-bottom: 1px solid var(--beige); display: flex; justify-content: space-between;">
                        <div><div style="font-weight: 600; color: var(--forest);">${formatted}</div>
                        <span style="font-size: 0.85rem; color: ${d.checkOut ? '#666' : '#ef4444'};">${d.checkOut ? 'Durasi: ' + calcHours(d.checkIn, d.checkOut) : 'Belum Check Out'}</span></div>
                        <div style="display: flex; gap: 1rem; font-size: 0.9rem;"><div><i class="fas fa-sign-in-alt" style="color: #10b981;"></i> ${d.checkIn || '-'}</div>
                        <div><i class="fas fa-sign-out-alt" style="color: #ef4444;"></i> ${d.checkOut || '-'}</div></div></div>`;
                }).join('');
            document.getElementById('history').innerHTML = html;
        }

        async function checkIn() {
            const now = new Date();
            const date = now.toISOString().split('T')[0];
            const time = now.toLocaleTimeString('id-ID');
            const data = { username: currentUser.username, fullName: currentUser.fullName, date, checkIn: time, checkOut: null };
            
            if (window.firebaseEnabled && window.firebaseDb) {
                try {
                    const { doc, setDoc, serverTimestamp } = window.firebaseModules;
                    await setDoc(doc(window.firebaseDb, 'attendance', `${currentUser.username}_${date}`), { ...data, timestamp: serverTimestamp() });
                    showAlert('‚úÖ Check In berhasil! (Cloud)', 'success');
                } catch (e) {
                    console.log('Firebase error, using local');
                    saveLocal(data);
                    showAlert('‚úÖ Check In berhasil! (Local)', 'success');
                }
            } else {
                saveLocal(data);
                showAlert('‚úÖ Check In berhasil! (Local)', 'success');
            }
            setTimeout(() => loadAbsensi(currentUser), 1000);
        }

        async function checkOut() {
            const now = new Date();
            const date = now.toISOString().split('T')[0];
            const time = now.toLocaleTimeString('id-ID');
            
            if (window.firebaseEnabled && window.firebaseDb) {
                try {
                    const { doc, updateDoc, serverTimestamp } = window.firebaseModules;
                    await updateDoc(doc(window.firebaseDb, 'attendance', `${currentUser.username}_${date}`), { checkOut: time, checkOutTimestamp: serverTimestamp() });
                    showAlert('‚úÖ Check Out berhasil! (Cloud)', 'success');
                } catch (e) {
                    console.log('Firebase error, using local');
                    updateLocal(date, time);
                    showAlert('‚úÖ Check Out berhasil! (Local)', 'success');
                }
            } else {
                updateLocal(date, time);
                showAlert('‚úÖ Check Out berhasil! (Local)', 'success');
            }
            setTimeout(() => loadAbsensi(currentUser), 1000);
        }

        function saveLocal(data) {
            const local = JSON.parse(localStorage.getItem('attendance_' + currentUser.username) || '{}');
            local[data.date] = data;
            localStorage.setItem('attendance_' + currentUser.username, JSON.stringify(local));
        }

        function updateLocal(date, time) {
            const local = JSON.parse(localStorage.getItem('attendance_' + currentUser.username) || '{}');
            if (local[date]) {
                local[date].checkOut = time;
                localStorage.setItem('attendance_' + currentUser.username, JSON.stringify(local));
            }
        }

        function calcHours(checkIn, checkOut) {
            if (!checkIn || !checkOut) return '-';
            try {
                const [h1, m1] = checkIn.split(':').map(n => parseInt(n, 10));
                const [h2, m2] = checkOut.split(':').map(n => parseInt(n, 10));
                if (isNaN(h1) || isNaN(m1) || isNaN(h2) || isNaN(m2)) return '-';
                let diff = (h2 * 60 + m2) - (h1 * 60 + m1);
                if (diff < 0) diff += 24 * 60;
                return `${Math.floor(diff / 60)} jam ${diff % 60} menit`;
            } catch (e) { return '-'; }
        }

        function backToSelection() {
            document.getElementById('absensiContainer').classList.remove('active');
            document.getElementById('appSelectionPage').classList.add('active');
        }

        function showAlert(msg, type) {
            document.querySelectorAll('.alert-custom').forEach(el => el.remove());
            const div = document.createElement('div');
            div.className = `alert-custom alert-${type}`;
            div.innerHTML = `<div style="display: flex; align-items: center; justify-content: space-between;"><span><i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>${msg}</span><button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: inherit; cursor: pointer; padding: 0; margin-left: 1rem;"><i class="fas fa-times"></i></button></div>`;
            document.body.appendChild(div);
            setTimeout(() => { if (div.parentNode) div.remove(); }, 5000);
        }

        window.addEventListener('load', () => {
            setTimeout(() => {
                const saved = localStorage.getItem('pinuslo_user');
                if (saved) {
                    const user = JSON.parse(saved);
                    currentUser = user;
                    showAppSelection(user);
                }
                console.log('üöÄ Pinuslo Apps - Unified Management System');
                console.log(window.firebaseEnabled ? '‚úÖ Firebase Connected - Cloud Storage' : '‚ö†Ô∏è Firebase Offline - Local Storage');
                console.log('');
                console.log('üìã Akun Super Admin (Akses Semua):');
                console.log('   ‚Ä¢ yuzar / yuzar123');
                console.log('   ‚Ä¢ iqbal / iqbal123');
                console.log('');
                console.log('üìã Akun Staff (Akses Absensi):');
                console.log('   ‚Ä¢ agus, selfi, fadel, farel, ikki, sadiq');
                console.log('   ‚Ä¢ sirad, bate, boncel, pian, juned');
                console.log('   ‚Ä¢ Password: [nama]123');
                console.log('');
                console.log('üåê Aplikasi Tersedia:');
                console.log('   üå≤ Pinus Selow Regist ‚Üí pinusselowregist.netlify.app');
                console.log('   üíß Pinewater ‚Üí pinewater.netlify.app');
                console.log('   ‚õΩ BBM Management ‚Üí bbm-management.netlify.app');
                console.log('   üîê Absensi ‚Üí Internal System');
            }, 500);
        });
    </script>
</body>
</html>
