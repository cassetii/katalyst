<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pinuslo Apps - Management System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <!-- Firebase SDK v9 (Modular) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, query, where, orderBy, limit, getDocs, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyAEyZF2Ib10UD7vv8l3nclb-KfChIczIz4",
            authDomain: "pinewater-393fe.firebaseapp.com",
            projectId: "pinewater-393fe",
            storageBucket: "pinewater-393fe.firebasestorage.app",
            messagingSenderId: "1039943692827",
            appId: "1:1039943692827:web:014dd0b891143a8a95febe",
            measurementId: "G-931M74XQQK"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            console.log('‚úÖ Firebase connected');
            window.firebaseDb = db;
            window.firebaseEnabled = true;
            window.firebaseModules = { collection, doc, setDoc, getDoc, updateDoc, query, where, orderBy, limit, getDocs, serverTimestamp };
        } catch (error) {
            console.error('‚ùå Firebase failed:', error);
            window.firebaseEnabled = false;
        }
    </script>
    
    <style>
        :root {
            --cream: #F5F5F0;
            --beige: #E6D8C3;
            --tan: #C2A68C;
            --forest: #5D866C;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, var(--cream) 0%, var(--beige) 100%); min-height: 100vh; }
        .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; background: linear-gradient(135deg, var(--forest) 0%, var(--tan) 100%); }
        .login-card { background: white; border-radius: 20px; padding: 2.5rem; box-shadow: 0 20px 60px rgba(93, 134, 108, 0.3); width: 100%; max-width: 420px; animation: slideIn 0.8s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
        .login-logo { width: 90px; height: 90px; background: linear-gradient(135deg, var(--forest) 0%, var(--tan) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; color: white; font-size: 2.5rem; box-shadow: 0 8px 25px rgba(93, 134, 108, 0.4); }
        .login-title { color: var(--forest); font-weight: 700; font-size: 1.8rem; text-align: center; margin-bottom: 0.5rem; }
        .login-subtitle { color: var(--tan); font-size: 0.95rem; text-align: center; margin-bottom: 2rem; }
        .login-input-container { position: relative; margin-bottom: 1.5rem; }
        .login-input { width: 100%; padding: 1rem 1rem 1rem 3rem; border: 2px solid var(--beige); border-radius: 12px; font-size: 1rem; transition: all 0.3s ease; background: var(--cream); }
        .login-input:focus { border-color: var(--forest); box-shadow: 0 0 0 0.2rem rgba(93, 134, 108, 0.25); outline: none; background: white; }
        .login-input-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--forest); font-size: 1.1rem; }
        .password-toggle { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); color: var(--tan); cursor: pointer; }
        .login-btn { width: 100%; padding: 1.1rem; background: linear-gradient(135deg, var(--forest) 0%, var(--tan) 100%); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(93, 134, 108, 0.3); }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(93, 134, 108, 0.4); }
        .app-selection-container { min-height: 100vh; padding: 2rem; background: linear-gradient(135deg, var(--cream) 0%, var(--beige) 100%); }
        .user-welcome { background: white; border-radius: 15px; padding: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; max-width: 1200px; margin: 0 auto 3rem; }
        .user-avatar { width: 60px; height: 60px; background: linear-gradient(135deg, var(--forest) 0%, var(--tan) 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: bold; }
        .logout-btn { background: var(--tan); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-weight: 500; }
        .logout-btn:hover { background: var(--forest); transform: translateY(-2px); }
        .apps-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
        .app-card { background: white; border-radius: 20px; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; border: 3px solid transparent; }
        .app-card:hover { transform: translateY(-10px); box-shadow: 0 15px 40px rgba(0,0,0,0.15); border-color: var(--forest); }
        .app-icon { width: 80px; height: 80px; border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; font-size: 2.5rem; color: white; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .app-card.pinus { background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%); }
        .app-card.pinus .app-icon { background: linear-gradient(135deg, var(--forest) 0%, #3b7a5e 100%); }
        .app-card.pinewater { background: linear-gradient(135deg, #ffffff 0%, #ecfeff 100%); }
        .app-card.pinewater .app-icon { background: linear-gradient(135deg, #0891b2 0%, #06b6d4 100%); }
        .app-card.bbm { background: linear-gradient(135deg, #ffffff 0%, #fef3c7 100%); }
        .app-card.bbm .app-icon { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .app-card.absensi { background: linear-gradient(135deg, #ffffff 0%, #f3e8ff 100%); }
        .app-card.absensi .app-icon { background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); }
        .app-card.cafe { background: linear-gradient(135deg, #ffffff 0%, #fef2f2 100%); }
        .app-card.cafe .app-icon { background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); }
        .app-card.glamping { background: linear-gradient(135deg, #ffffff 0%, #fff7ed 100%); }
        .app-card.glamping .app-icon { background: linear-gradient(135deg, #ea580c 0%, #c2410c 100%); }
        .page-section { display: none; }
        .page-section.active { display: block; }
        .alert-custom { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; min-width: 300px; max-width: 90%; border-radius: 12px; padding: 1rem 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideDown 0.5s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateX(-50%) translateY(-20px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        .alert-success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .alert-danger { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .alert-warning { background: #fef3c7; color: #92400e; border: 1px solid #fde68a; }
        .tab-menu { display: flex; gap: 0.5rem; margin-bottom: 2rem; border-bottom: 2px solid var(--beige); }
        .tab-btn { padding: 1rem 2rem; background: none; border: none; color: var(--tan); cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .tab-btn.active { color: var(--forest); border-bottom-color: var(--forest); }
        .tab-btn:hover { color: var(--forest); }
        .report-table { width: 100%; border-collapse: collapse; }
        .report-table th { background: var(--forest); color: white; padding: 1rem; text-align: left; font-weight: 600; }
        .report-table td { padding: 1rem; border-bottom: 1px solid var(--beige); }
        .report-table tr:hover { background: var(--cream); }
        .status-badge { display: inline-block; padding: 0.4rem 0.8rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; }
        .status-approved { background: #d1fae5; color: #065f46; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-incomplete { background: #fee2e2; color: #991b1b; }
        .approve-btn { background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-size: 0.85rem; transition: all 0.3s ease; }
        .approve-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3); }
        .approve-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .filter-section { display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; align-items: center; }
        .filter-input { padding: 0.8rem; border: 2px solid var(--beige); border-radius: 10px; font-size: 0.95rem; background: white; }
        .filter-btn { padding: 0.8rem 1.5rem; background: var(--forest); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
        .filter-btn:hover { background: var(--tan); transform: translateY(-2px); }
        .export-btn { padding: 0.8rem 1.5rem; background: linear-gradient(135deg, #0891b2, #06b6d4); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
        .export-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(8, 145, 178, 0.3); }
        #map { height: 350px; border-radius: 15px; margin-bottom: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .location-status { padding: 1rem; background: var(--cream); border-radius: 10px; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .location-status.inside { background: #d1fae5; color: #065f46; }
        .location-status.outside { background: #fee2e2; color: #991b1b; }
        .location-status.loading { background: #fef3c7; color: #92400e; }
        .wifi-requirement { background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 2px solid #3b82f6; border-radius: 15px; padding: 1.5rem; margin-bottom: 1.5rem; }
        .wifi-status { display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: 10px; margin-bottom: 1rem; }
        .wifi-connected { background: #d1fae5; color: #065f46; }
        .wifi-disconnected { background: #fee2e2; color: #991b1b; }
        .wifi-checking { background: #fef3c7; color: #92400e; }
        .validation-warning { background: linear-gradient(135deg, #fef2f2, #fee2e2); border: 2px solid #ef4444; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        .btn-disabled-custom { opacity: 0.4 !important; cursor: not-allowed !important; position: relative; }
        .btn-disabled-custom::after { content: 'üîí'; position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); font-size: 1.2rem; }
    </style>
</head>
<body>
    <div id="loginPage" class="page-section active">
        <div class="login-container">
            <div class="login-card">
                <div class="login-logo"><i class="fas fa-rocket"></i></div>
                <h2 class="login-title">Pinuslo Apps</h2>
                <p class="login-subtitle">Unified Management Platform</p>
                <form onsubmit="return handleLogin(event)">
                    <div class="login-input-container">
                        <input type="text" class="login-input" id="username" placeholder="Username" required>
                        <div class="login-input-icon"><i class="fas fa-user"></i></div>
                    </div>
                    <div class="login-input-container">
                        <input type="password" class="login-input" id="password" placeholder="Password" required>
                        <div class="login-input-icon"><i class="fas fa-lock"></i></div>
                        <div class="password-toggle" onclick="togglePassword()"><i class="fas fa-eye" id="passwordToggleIcon"></i></div>
                    </div>
                    <button type="submit" class="login-btn"><i class="fas fa-sign-in-alt me-2"></i>Masuk</button>
                </form>
            </div>
        </div>
    </div>

    <div id="appSelectionPage" class="page-section">
        <div class="app-selection-container">
            <div class="user-welcome">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div class="user-avatar" id="userAvatar">I</div>
                    <div>
                        <h3 id="userName" style="color: var(--forest); margin: 0;">User</h3>
                        <p id="userRole" style="color: var(--tan); margin: 0; font-size: 0.9rem;">Staff</p>
                    </div>
                </div>
                <button class="logout-btn" onclick="handleLogout()"><i class="fas fa-sign-out-alt me-2"></i>Keluar</button>
            </div>
            <div style="text-align: center; margin-bottom: 3rem;">
                <h1 style="color: var(--forest); font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">Pilih Aplikasi</h1>
                <p style="color: var(--tan); font-size: 1.1rem;">Silakan pilih aplikasi yang ingin Anda gunakan</p>
            </div>
            <div class="apps-grid">
                <div class="app-card pinus" data-app="pinus">
                    <div class="app-icon"><i class="fas fa-tree"></i></div>
                    <h3 style="color: var(--forest); font-size: 1.5rem; text-align: center; margin-bottom: 0.5rem;">Pinus Selow Regist</h3>
                    <p style="color: var(--tan); text-align: center; font-size: 0.95rem;">Sistem Pendaftaran & Manajemen Pinus</p>
                </div>
                <div class="app-card pinewater" data-app="pinewater">
                    <div class="app-icon"><i class="fas fa-water"></i></div>
                    <h3 style="color: var(--forest); font-size: 1.5rem; text-align: center; margin-bottom: 0.5rem;">Pinewater</h3>
                    <p style="color: var(--tan); text-align: center; font-size: 0.95rem;">Sistem Manajemen Air & Distribusi</p>
                </div>
                <div class="app-card bbm" data-app="bbm">
                    <div class="app-icon"><i class="fas fa-gas-pump"></i></div>
                    <h3 style="color: var(--forest); font-size: 1.5rem; text-align: center; margin-bottom: 0.5rem;">BBM Management</h3>
                    <p style="color: var(--tan); text-align: center; font-size: 0.95rem;">Sistem Manajemen Bahan Bakar Minyak</p>
                </div>
                <div class="app-card cafe" data-app="cafe">
                    <div class="app-icon"><i class="fas fa-coffee"></i></div>
                    <h3 style="color: var(--forest); font-size: 1.5rem; text-align: center; margin-bottom: 0.5rem;">Pinuslo Cafe</h3>
                    <p style="color: var(--tan); text-align: center; font-size: 0.95rem;">Sistem Manajemen Cafe & Point of Sale</p>
                </div>
                <div class="app-card glamping" data-app="glamping">
                    <div class="app-icon"><i class="fas fa-campground"></i></div>
                    <h3 style="color: var(--forest); font-size: 1.5rem; text-align: center; margin-bottom: 0.5rem;">Pinuslo Glamping</h3>
                    <p style="color: var(--tan); text-align: center; font-size: 0.95rem;">Sistem Reservasi & Manajemen Glamping</p>
                </div>
                <div class="app-card absensi" data-app="absensi">
                    <div class="app-icon"><i class="fas fa-fingerprint"></i></div>
                    <h3 style="color: var(--forest); font-size: 1.5rem; text-align: center; margin-bottom: 0.5rem;">Absensi</h3>
                    <p style="color: var(--tan); text-align: center; font-size: 0.95rem;">Sistem Absensi & Kehadiran Karyawan</p>
                </div>
            </div>
        </div>
    </div>

    <div id="absensiContainer" class="page-section"></div>

    <script>
        let currentUser = null;
        let map = null;
        let userMarker = null;
        let currentLocation = null;
        let geofenceCircle = null;
        let validationInterval = null;
        let isValidForAttendance = false;
        
        // Single Point Geofencing - Cafepinuslo Location
        const GEOFENCE_CENTER = {
            lat: -5.367065295968101,
            lon: 119.6489802711651
        };
        const GEOFENCE_RADIUS = 50; // meters - strict radius for WiFi area
        
        // WiFi Requirements
        const REQUIRED_WIFI = {
            ssid: "Cafepinuslo",
            bssid: "96:3c:80:6a:83:6d",
            security: "WPA2/WP3 Personal"
        };

        const allUsers = [
            { username: 'iqbal', password: 'iqbal123', role: 'admin', fullName: 'Iqbal', apps: ['pinus', 'pinewater', 'bbm', 'cafe', 'glamping', 'absensi'] },
            { username: 'jendra', password: 'jendra123', role: 'admin', fullName: 'Jendra', apps: ['cafe', 'absensi'] },
            { username: 'selow', password: 'selow123', role: 'admin', fullName: 'Selow', apps: ['pinus', 'pinewater', 'absensi'] },
            { username: 'komandan', password: 'komandan123', role: 'admin', fullName: 'Komandan', apps: ['pinewater', 'bbm', 'absensi'] },
            { username: 'agus', password: 'agus123', role: 'user', fullName: 'Agus', apps: ['pinus', 'cafe', 'glamping', 'absensi'] },
            { username: 'selfi', password: 'selfi123', role: 'user', fullName: 'Selfi', apps: ['pinus', 'cafe', 'glamping', 'absensi'] },
            { username: 'fadel', password: 'fadel123', role: 'user', fullName: 'Fadel', apps: ['cafe', 'absensi'] },
            { username: 'farel', password: 'farel123', role: 'user', fullName: 'Farel', apps: ['cafe', 'absensi'] },
            { username: 'sadiq', password: 'sadiq123', role: 'user', fullName: 'Sadiq', apps: ['cafe', 'absensi'] },
            { username: 'sirad', password: 'sirad123', role: 'user', fullName: 'Sirad', apps: ['pinus', 'pinewater', 'cafe', 'glamping', 'absensi'] },
            { username: 'bate', password: 'bate123', role: 'user', fullName: 'Bate', apps: ['pinus', 'cafe', 'absensi'] },
            { username: 'zulkifli', password: 'zulkifli123', role: 'user', fullName: 'Zulkifli', apps: ['pinus', 'pinewater', 'absensi'] },
            { username: 'ikki', password: 'ikki123', role: 'user', fullName: 'Ikki', apps: ['pinus', 'cafe', 'absensi'] },
            { username: 'chulo', password: 'chulo123', role: 'user', fullName: 'Chulo', apps: ['glamping'] },
            { username: 'pian', password: 'pian123', role: 'user', fullName: 'Pian', apps: ['glamping'] },
            { username: 'imbang', password: 'imbang123', role: 'user', fullName: 'Imbang', apps: ['glamping'] },
            { username: 'roy', password: 'roy123', role: 'user', fullName: 'Roy', apps: ['pinewater', 'glamping'] }
        ];

        const appUrls = {
            'pinus': 'https://pinusselowregist.netlify.app',
            'pinewater': 'https://pinewater.netlify.app',
            'bbm': 'https://pinebbm.netlify.app',
            'cafe': 'https://pinuslocafe.netlify.app',
            'glamping': 'https://pinuslo-glamping.netlify.app'
        };

        let currentAbsensiView = 'check';

        // Haversine Formula - Calculate distance between two points
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // Earth radius in meters
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ / 2) * Math.sin(ŒîœÜ / 2) +
                    Math.cos(œÜ1) * Math.cos(œÜ2) *
                    Math.sin(ŒîŒª / 2) * Math.sin(ŒîŒª / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // Distance in meters
        }

        function isInGeofence(lat, lon) {
            const distance = getDistance(lat, lon, GEOFENCE_CENTER.lat, GEOFENCE_CENTER.lon);
            return distance <= GEOFENCE_RADIUS;
        }

        async function checkWiFiConnection() {
            // Check if online
            if (!navigator.onLine) {
                return { connected: false, reason: 'Tidak terhubung ke internet' };
            }

            // Check network type (WiFi detection)
            if ('connection' in navigator) {
                const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                if (connection) {
                    // If on cellular, definitely not on WiFi
                    if (connection.type && connection.type !== 'wifi') {
                        return { connected: false, reason: 'Menggunakan data seluler, bukan WiFi' };
                    }
                }
            }

            // Additional validation: must be very close to the location (within 50m)
            if (currentLocation) {
                const distance = getDistance(
                    currentLocation.lat, 
                    currentLocation.lon, 
                    GEOFENCE_CENTER.lat, 
                    GEOFENCE_CENTER.lon
                );
                
                if (distance <= GEOFENCE_RADIUS) {
                    return { connected: true, reason: 'Terkoneksi dan berada di lokasi', distance: Math.round(distance) };
                } else {
                    return { connected: false, reason: `Terlalu jauh dari WiFi (${Math.round(distance)}m dari area)`, distance: Math.round(distance) };
                }
            }

            return { connected: false, reason: 'Lokasi belum terdeteksi' };
        }

        async function validateAttendanceConditions() {
            const wifiCheck = await checkWiFiConnection();
            const locationValid = currentLocation && isInGeofence(currentLocation.lat, currentLocation.lon);
            
            isValidForAttendance = wifiCheck.connected && locationValid;
            
            updateButtonStates();
            updateValidationWarning(wifiCheck, locationValid);
            
            return isValidForAttendance;
        }

        function updateButtonStates() {
            const checkInBtn = document.getElementById('checkInBtn');
            const checkOutBtn = document.getElementById('checkOutBtn');
            
            if (!checkInBtn || !checkOutBtn) return;
            
            // Get current attendance status
            const today = new Date().toISOString().split('T')[0];
            loadData(currentUser.username, today).then(todayData => {
                const isIn = todayData && todayData.checkIn && !todayData.checkOut;
                const isDone = todayData && todayData.checkOut;
                
                // Check In button
                if (!isValidForAttendance || isIn || isDone) {
                    checkInBtn.disabled = true;
                    checkInBtn.classList.add('btn-disabled-custom');
                } else {
                    checkInBtn.disabled = false;
                    checkInBtn.classList.remove('btn-disabled-custom');
                }
                
                // Check Out button
                if (!isValidForAttendance || !isIn || isDone) {
                    checkOutBtn.disabled = true;
                    checkOutBtn.classList.add('btn-disabled-custom');
                } else {
                    checkOutBtn.disabled = false;
                    checkOutBtn.classList.remove('btn-disabled-custom');
                }
            });
        }

        function updateValidationWarning(wifiCheck, locationValid) {
            const warningDiv = document.getElementById('validationWarning');
            if (!warningDiv) return;
            
            if (!isValidForAttendance) {
                let reasons = [];
                
                if (!wifiCheck.connected) {
                    reasons.push(`<div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;"><i class="fas fa-wifi" style="font-size: 1.2rem;"></i><div><strong>WiFi:</strong> ${wifiCheck.reason}</div></div>`);
                }
                
                if (!locationValid) {
                    const dist = wifiCheck.distance || 0;
                    reasons.push(`<div style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-map-marker-alt" style="font-size: 1.2rem;"></i><div><strong>Lokasi:</strong> ${dist > 0 ? `Anda berada ${dist}m dari area (maksimal ${GEOFENCE_RADIUS}m)` : 'Di luar area WiFi Cafepinuslo'}</div></div>`);
                }
                
                warningDiv.style.display = 'block';
                warningDiv.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 1rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #dc2626;"></i>
                        <div style="flex: 1;">
                            <h4 style="color: #991b1b; margin-bottom: 0.8rem; font-size: 1.1rem;">üîí Check In/Out Tidak Tersedia</h4>
                            <p style="margin-bottom: 1rem; color: #7f1d1d;">Anda tidak dapat melakukan absensi karena:</p>
                            ${reasons.join('')}
                            <div style="margin-top: 1rem; padding: 0.8rem; background: white; border-radius: 8px; border-left: 4px solid #dc2626;">
                                <strong>Solusi:</strong> Pastikan Anda terhubung ke WiFi <strong>"${REQUIRED_WIFI.ssid}"</strong> dan berada dalam radius ${GEOFENCE_RADIUS}m dari lokasi.
                            </div>
                        </div>
                    </div>
                `;
            } else {
                warningDiv.style.display = 'none';
            }
        }

        function startValidationMonitoring() {
            // Clear existing interval
            if (validationInterval) {
                clearInterval(validationInterval);
            }
            
            // Validate immediately
            validateAttendanceConditions();
            
            // Then validate every 5 seconds
            validationInterval = setInterval(() => {
                validateAttendanceConditions();
            }, 5000);
        }

        function stopValidationMonitoring() {
            if (validationInterval) {
                clearInterval(validationInterval);
                validationInterval = null;
            }
        }

        function initMap() {
            if (map) {
                map.remove();
            }
            
            map = L.map('map').setView([GEOFENCE_CENTER.lat, GEOFENCE_CENTER.lon], 18);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Draw geofence circle
            geofenceCircle = L.circle([GEOFENCE_CENTER.lat, GEOFENCE_CENTER.lon], {
                color: '#5D866C',
                fillColor: '#5D866C',
                fillOpacity: 0.2,
                radius: GEOFENCE_RADIUS,
                weight: 3
            }).addTo(map);
            
            geofenceCircle.bindPopup(`<strong>Area WiFi Cafepinuslo</strong><br>Radius: ${GEOFENCE_RADIUS}m<br>Anda harus berada dalam area ini`);
            
            // Center marker
            const centerIcon = L.divIcon({
                html: '<div style="background: #dc2626; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.4);"></div>',
                iconSize: [16, 16],
                className: ''
            });
            
            L.marker([GEOFENCE_CENTER.lat, GEOFENCE_CENTER.lon], { icon: centerIcon }).addTo(map)
                .bindPopup('<strong>üìç Cafepinuslo</strong><br>Titik WiFi Center');
        }

        function updateUserLocation(lat, lon) {
            currentLocation = { lat, lon };
            
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            
            const distance = getDistance(lat, lon, GEOFENCE_CENTER.lat, GEOFENCE_CENTER.lon);
            const isInside = distance <= GEOFENCE_RADIUS;
            
            const icon = L.divIcon({
                html: `<div style="background: ${isInside ? '#10b981' : '#ef4444'}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>`,
                iconSize: [20, 20],
                className: ''
            });
            
            userMarker = L.marker([lat, lon], { icon }).addTo(map);
            userMarker.bindPopup(`<strong>Lokasi Anda</strong><br>${isInside ? '‚úÖ Di dalam area WiFi' : '‚ùå Di luar area WiFi'}<br>Jarak: ${Math.round(distance)}m`);
            
            map.setView([lat, lon], 18);
            
            // Update location status
            const statusDiv = document.getElementById('locationStatus');
            if (statusDiv) {
                if (isInside) {
                    statusDiv.className = 'location-status inside';
                    statusDiv.innerHTML = `<i class="fas fa-check-circle" style="font-size: 1.5rem;"></i><div><strong>Lokasi Valid ‚úÖ</strong><br><small>Dalam radius ${Math.round(distance)}m dari WiFi Cafepinuslo</small></div>`;
                } else {
                    statusDiv.className = 'location-status outside';
                    statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle" style="font-size: 1.5rem;"></i><div><strong>Lokasi Tidak Valid ‚ùå</strong><br><small>Anda ${Math.round(distance)}m dari WiFi Cafepinuslo (maksimal ${GEOFENCE_RADIUS}m)</small></div>`;
                }
            }

            // Update WiFi status and validate
            updateWiFiStatus();
            validateAttendanceConditions();
        }

        async function updateWiFiStatus() {
            const wifiStatusDiv = document.getElementById('wifiStatus');
            if (!wifiStatusDiv) return;

            wifiStatusDiv.className = 'wifi-status wifi-checking';
            wifiStatusDiv.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size: 1.5rem;"></i><div><strong>Memeriksa Koneksi WiFi...</strong></div>';

            const wifiCheck = await checkWiFiConnection();
            
            if (wifiCheck.connected) {
                wifiStatusDiv.className = 'wifi-status wifi-connected';
                wifiStatusDiv.innerHTML = `<i class="fas fa-wifi" style="font-size: 1.5rem;"></i><div><strong>WiFi Terhubung ‚úÖ</strong><br><small>${wifiCheck.reason}</small></div>`;
            } else {
                wifiStatusDiv.className = 'wifi-status wifi-disconnected';
                wifiStatusDiv.innerHTML = `<i class="fas fa-exclamation-circle" style="font-size: 1.5rem;"></i><div><strong>WiFi Tidak Terhubung ‚ùå</strong><br><small>${wifiCheck.reason}</small></div>`;
            }
        }

        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation tidak didukung browser Anda'));
                    return;
                }
                
                const statusDiv = document.getElementById('locationStatus');
                if (statusDiv) {
                    statusDiv.className = 'location-status loading';
                    statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin" style="font-size: 1.5rem;"></i><div><strong>Mendapatkan Lokasi...</strong><br><small>Mohon tunggu</small></div>';
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        updateUserLocation(lat, lon);
                        resolve({ lat, lon });
                    },
                    (error) => {
                        const statusDiv = document.getElementById('locationStatus');
                        if (statusDiv) {
                            statusDiv.className = 'location-status outside';
                            statusDiv.innerHTML = '<i class="fas fa-times-circle" style="font-size: 1.5rem;"></i><div><strong>Error Lokasi</strong><br><small>Izinkan akses lokasi di browser Anda</small></div>';
                        }
                        reject(error);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }

        function togglePassword() {
            const input = document.getElementById('password');
            const icon = document.getElementById('passwordToggleIcon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const user = allUsers.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('pinuslo_user', JSON.stringify(user));
                showAlert('Login berhasil! Selamat datang, ' + user.fullName, 'success');
                setTimeout(() => showAppSelection(user), 1000);
            } else {
                showAlert('Username atau password salah!', 'danger');
            }
            return false;
        }

        function showAppSelection(user) {
            document.getElementById('loginPage').classList.remove('active');
            document.getElementById('appSelectionPage').classList.add('active');
            document.getElementById('userAvatar').textContent = user.fullName.charAt(0).toUpperCase();
            document.getElementById('userName').textContent = user.fullName;
            document.getElementById('userRole').textContent = user.role === 'admin' ? 'Administrator' : 'User';
            
            setTimeout(() => {
                document.querySelectorAll('.app-card').forEach(card => {
                    const appType = card.getAttribute('data-app');
                    if (!user.apps.includes(appType)) {
                        card.style.opacity = '0.5';
                        card.style.cursor = 'not-allowed';
                        card.onclick = () => showAlert('Anda tidak memiliki akses', 'danger');
                    } else {
                        card.onclick = () => {
                            if (appType === 'absensi') {
                                loadAbsensi(user);
                            } else if (appUrls[appType]) {
                                const appNames = {
                                    'pinus': 'Pinus Selow Regist',
                                    'pinewater': 'Pinewater',
                                    'bbm': 'BBM Management',
                                    'cafe': 'Pinuslo Cafe',
                                    'glamping': 'Pinuslo Glamping'
                                };
                                showAlert('Membuka ' + appNames[appType] + '...', 'success');
                                setTimeout(() => {
                                    window.open(appUrls[appType], '_blank');
                                }, 500);
                            }
                        };
                    }
                });
            }, 100);
        }

        function handleLogout() {
            if (confirm('Yakin ingin keluar?')) {
                stopValidationMonitoring();
                currentUser = null;
                localStorage.removeItem('pinuslo_user');
                document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
                document.getElementById('loginPage').classList.add('active');
                document.querySelector('form').reset();
                showAlert('Berhasil keluar', 'success');
            }
        }

        async function loadAbsensi(user) {
            document.getElementById('appSelectionPage').classList.remove('active');
            const container = document.getElementById('absensiContainer');
            container.classList.add('active');
            currentAbsensiView = 'check';
            
            const today = new Date().toISOString().split('T')[0];
            const todayData = await loadData(user.username, today);
            const isIn = todayData && todayData.checkIn && !todayData.checkOut;
            const isDone = todayData && todayData.checkOut;
            
            container.innerHTML = `
                <div style="min-height: 100vh; background: linear-gradient(135deg, var(--cream) 0%, var(--beige) 100%); padding: 2rem;">
                    <div style="max-width: 1400px; margin: 0 auto;">
                        <div style="background: white; border-radius: 15px; padding: 1.5rem; margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #a855f7, #9333ea); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;"><i class="fas fa-shield-alt"></i></div>
                                <div>
                                    <h2 style="margin: 0; color: var(--forest);">Sistem Absensi ‚Ä¢ Validasi Ketat</h2>
                                    <p style="margin: 0; color: var(--tan); font-size: 0.9rem;">${user.fullName} ‚Ä¢ WiFi + Lokasi Protected</p>
                                </div>
                            </div>
                            <button onclick="backToSelection()" style="padding: 0.8rem 1.5rem; background: var(--tan); color: white; border: none; border-radius: 10px; cursor: pointer;"><i class="fas fa-arrow-left me-2"></i>Kembali</button>
                        </div>

                        <div class="wifi-requirement">
                            <h4 style="color: #1e40af; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-lock"></i> Persyaratan Koneksi Wajib
                            </h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <div>
                                    <div style="font-weight: 600; color: #1e3a8a; margin-bottom: 0.3rem;"><i class="fas fa-wifi me-2"></i>WiFi SSID:</div>
                                    <div style="background: white; padding: 0.5rem; border-radius: 8px; font-family: monospace;">${REQUIRED_WIFI.ssid}</div>
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: #1e3a8a; margin-bottom: 0.3rem;"><i class="fas fa-lock me-2"></i>Security:</div>
                                    <div style="background: white; padding: 0.5rem; border-radius: 8px;">${REQUIRED_WIFI.security}</div>
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: #1e3a8a; margin-bottom: 0.3rem;"><i class="fas fa-map-marker-alt me-2"></i>Radius Maksimal:</div>
                                    <div style="background: white; padding: 0.5rem; border-radius: 8px; font-weight: bold;">${GEOFENCE_RADIUS} meter dari titik WiFi</div>
                                </div>
                            </div>
                        </div>

                        <div id="validationWarning" class="validation-warning" style="display: none;"></div>
                        
                        <div class="tab-menu">
                            <button class="tab-btn active" onclick="switchTab('check')"><i class="fas fa-fingerprint me-2"></i>Check In/Out</button>
                            <button class="tab-btn" onclick="switchTab('history')"><i class="fas fa-history me-2"></i>Riwayat</button>
                            ${user.role === 'admin' ? '<button class="tab-btn" onclick="switchTab(\'reports\')"><i class="fas fa-chart-bar me-2"></i>Laporan</button>' : ''}
                        </div>
                        
                        <div id="checkView" class="tab-content">
                            <div style="display: grid; grid-template-columns: 1.2fr 1fr; gap: 2rem;">
                                <div style="background: white; border-radius: 20px; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                                    <h3 style="color: var(--forest); margin-bottom: 1rem;"><i class="fas fa-map-marked-alt me-2"></i>Monitor Lokasi & WiFi</h3>
                                    
                                    <div id="wifiStatus" class="wifi-status wifi-checking">
                                        <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem;"></i>
                                        <div><strong>Memeriksa WiFi...</strong></div>
                                    </div>
                                    
                                    <div id="locationStatus" class="location-status loading">
                                        <i class="fas fa-spinner fa-spin" style="font-size: 1.5rem;"></i>
                                        <div><strong>Memuat Lokasi...</strong><br><small>Mohon tunggu</small></div>
                                    </div>
                                    
                                    <div id="map"></div>
                                    
                                    <button onclick="refreshLocation()" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #0891b2, #06b6d4); color: white; border: none; border-radius: 12px; font-size: 1rem; cursor: pointer; margin-top: 1rem;">
                                        <i class="fas fa-sync-alt me-2"></i>Refresh Lokasi & WiFi
                                    </button>
                                </div>
                                <div style="background: white; border-radius: 20px; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                                    <h3 style="text-align: center; color: var(--forest); margin-bottom: 1rem;"><i class="fas fa-clock me-2"></i>Absensi Hari Ini</h3>
                                    <div id="clock" style="text-align: center; font-size: 2.5rem; font-weight: bold; color: var(--forest); margin: 1.5rem 0; font-family: monospace;">00:00:00</div>
                                    <div id="date" style="text-align: center; font-size: 1rem; color: var(--tan); margin-bottom: 1.5rem;"></div>
                                    <div style="text-align: center; margin-bottom: 1.5rem;">
                                        <span style="display: inline-block; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600; background: ${isDone ? 'rgba(168,85,247,0.15)' : isIn ? 'rgba(16,185,129,0.15)' : 'rgba(239,68,68,0.15)'}; color: ${isDone ? '#a855f7' : isIn ? '#059669' : '#dc2626'};">
                                            <i class="fas fa-${isDone ? 'check-circle' : isIn ? 'sign-in-alt' : 'clock'} me-2"></i>${isDone ? 'Selesai' : isIn ? 'Sudah Check In' : 'Belum Check In'}
                                        </span>
                                    </div>
                                    ${todayData ? `
                                        <div style="background: var(--cream); padding: 1.5rem; border-radius: 10px; margin-bottom: 1rem;">
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                                                <span><i class="fas fa-sign-in-alt me-2" style="color: #10b981;"></i>Check In:</span>
                                                <strong style="color: var(--forest);">${todayData.checkIn || '-'}</strong>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                                                <span><i class="fas fa-sign-out-alt me-2" style="color: #ef4444;"></i>Check Out:</span>
                                                <strong style="color: var(--forest);">${todayData.checkOut || '-'}</strong>
                                            </div>
                                            ${todayData.distance ? `
                                                <div style="padding-top: 1rem; border-top: 1px solid var(--beige);">
                                                    <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.3rem;">
                                                        <i class="fas fa-map-pin me-1"></i>Jarak dari WiFi: ${todayData.distance}m
                                                    </div>
                                                </div>
                                            ` : ''}
                                            ${todayData.checkOut ? `<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--beige); text-align: center;"><span style="color: #666;">Total Jam:</span><strong style="display: block; color: var(--forest); font-size: 1.2rem; margin-top: 0.5rem;">${calcHours(todayData.checkIn, todayData.checkOut)}</strong></div>` : ''}
                                        </div>
                                    ` : ''}
                                    <button id="checkInBtn" onclick="checkIn()" style="width: 100%; padding: 1.2rem; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 15px; font-size: 1.1rem; cursor: pointer; margin-bottom: 1rem;" disabled class="btn-disabled-custom"><i class="fas fa-sign-in-alt me-2"></i>Check In</button>
                                    <button id="checkOutBtn" onclick="checkOut()" style="width: 100%; padding: 1.2rem; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; border-radius: 15px; font-size: 1.1rem; cursor: pointer;" disabled class="btn-disabled-custom"><i class="fas fa-sign-out-alt me-2"></i>Check Out</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="historyView" class="tab-content" style="display: none;">
                            <div style="background: white; border-radius: 20px; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                                <h3 style="color: var(--forest); margin-bottom: 1.5rem;"><i class="fas fa-history me-2"></i>Riwayat Absensi Lengkap</h3>
                                <div id="historyFull" style="max-height: 600px; overflow-y: auto;"><p style="text-align: center; color: #999; padding: 2rem;">Memuat...</p></div>
                            </div>
                        </div>
                        
                        ${user.role === 'admin' ? `
                        <div id="reportsView" class="tab-content" style="display: none;">
                            <div style="background: white; border-radius: 20px; padding: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                                <h3 style="color: var(--forest); margin-bottom: 1.5rem;"><i class="fas fa-chart-bar me-2"></i>Laporan Absensi</h3>
                                
                                <div class="filter-section">
                                    <select id="reportType" class="filter-input" onchange="loadReports()">
                                        <option value="daily">Laporan Harian</option>
                                        <option value="weekly">Laporan Mingguan</option>
                                        <option value="monthly">Laporan Bulanan</option>
                                    </select>
                                    
                                    <input type="date" id="reportDate" class="filter-input" value="${new Date().toISOString().split('T')[0]}" onchange="loadReports()">
                                    
                                    <select id="reportUser" class="filter-input" onchange="loadReports()">
                                        <option value="all">Semua User</option>
                                        ${allUsers.filter(u => u.apps.includes('absensi')).map(u => `<option value="${u.username}">${u.fullName}</option>`).join('')}
                                    </select>
                                    
                                    <button class="filter-btn" onclick="loadReports()"><i class="fas fa-search me-2"></i>Filter</button>
                                    <button class="export-btn" onclick="exportReport()"><i class="fas fa-download me-2"></i>Export Excel</button>
                                </div>
                                
                                <div id="reportContent" style="overflow-x: auto;"></div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                initMap();
                getCurrentLocation()
                    .then(() => {
                        startValidationMonitoring();
                    })
                    .catch(err => {
                        console.error('Location error:', err);
                        showAlert('Gagal mendapatkan lokasi. Aktifkan GPS dan izinkan akses lokasi.', 'warning');
                    });
            }, 300);
            
            setInterval(() => {
                const now = new Date();
                const clockEl = document.getElementById('clock');
                const dateEl = document.getElementById('date');
                if (clockEl) clockEl.textContent = now.toLocaleTimeString('id-ID');
                if (dateEl) dateEl.textContent = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }, 1000);
            
            if (user.role === 'admin') {
                loadReports();
            }
        }

        function refreshLocation() {
            getCurrentLocation()
                .then(() => {
                    showAlert('‚úÖ Lokasi dan WiFi diperbarui!', 'success');
                    validateAttendanceConditions();
                })
                .catch(err => showAlert('Gagal mendapatkan lokasi: ' + err.message, 'danger'));
        }

        function switchTab(tab) {
            currentAbsensiView = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            
            if (tab === 'check') {
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                document.getElementById('checkView').style.display = 'block';
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 100);
                startValidationMonitoring();
            } else {
                stopValidationMonitoring();
                if (tab === 'history') {
                    document.querySelectorAll('.tab-btn')[1].classList.add('active');
                    document.getElementById('historyView').style.display = 'block';
                    loadHistory(currentUser.username, 'historyFull', 30);
                } else if (tab === 'reports') {
                    document.querySelectorAll('.tab-btn')[2].classList.add('active');
                    document.getElementById('reportsView').style.display = 'block';
                    loadReports();
                }
            }
        }

        async function loadReports() {
            const reportType = document.getElementById('reportType').value;
            const reportDate = new Date(document.getElementById('reportDate').value);
            const reportUser = document.getElementById('reportUser').value;
            
            let allData = {};
            
            if (reportUser === 'all') {
                for (const user of allUsers.filter(u => u.apps.includes('absensi'))) {
                    const userData = await loadAllUserData(user.username);
                    Object.assign(allData, userData);
                }
            } else {
                allData = await loadAllUserData(reportUser);
            }
            
            let filteredData = [];
            const dates = Object.keys(allData).sort().reverse();
            
            if (reportType === 'daily') {
                const targetDate = reportDate.toISOString().split('T')[0];
                filteredData = dates.filter(d => d === targetDate).map(d => allData[d]);
            } else if (reportType === 'weekly') {
                const weekStart = new Date(reportDate);
                weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                filteredData = dates.filter(d => {
                    const date = new Date(d);
                    return date >= weekStart && date <= weekEnd;
                }).map(d => allData[d]);
            } else if (reportType === 'monthly') {
                const month = reportDate.getMonth();
                const year = reportDate.getFullYear();
                
                filteredData = dates.filter(d => {
                    const date = new Date(d);
                    return date.getMonth() === month && date.getFullYear() === year;
                }).map(d => allData[d]);
            }
            
            let html = '<table class="report-table"><thead><tr>';
            html += '<th>No</th><th>Nama</th><th>Tanggal</th><th>Hari</th><th>Check In</th><th>Check Out</th><th>Jarak WiFi</th><th>Total Jam</th><th>Status</th>';
            if (currentUser.role === 'admin') html += '<th>Aksi</th>';
            html += '</tr></thead><tbody>';
            
            if (filteredData.length === 0) {
                html += '<tr><td colspan="10" style="text-align: center; padding: 2rem; color: #999;">Tidak ada data</td></tr>';
            } else {
                filteredData.forEach((data, index) => {
                    const date = new Date(data.date);
                    const dayName = date.toLocaleDateString('id-ID', { weekday: 'long' });
                    const formattedDate = date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
                    const totalHours = calcHours(data.checkIn, data.checkOut);
                    
                    let status = 'pending';
                    let statusText = 'Menunggu';
                    if (data.approved) {
                        status = 'approved';
                        statusText = 'Disetujui';
                    } else if (!data.checkOut) {
                        status = 'incomplete';
                        statusText = 'Belum Selesai';
                    }
                    
                    const distanceText = data.distance ? data.distance + 'm' : '-';
                    
                    html += `<tr>
                        <td>${index + 1}</td>
                        <td><strong>${data.fullName}</strong></td>
                        <td>${formattedDate}</td>
                        <td>${dayName}</td>
                        <td><span style="color: #10b981;"><i class="fas fa-sign-in-alt me-1"></i>${data.checkIn || '-'}</span></td>
                        <td><span style="color: #ef4444;"><i class="fas fa-sign-out-alt me-1"></i>${data.checkOut || '-'}</span></td>
                        <td style="font-size: 0.85rem;"><i class="fas fa-wifi me-1"></i>${distanceText}</td>
                        <td><strong>${totalHours}</strong></td>
                        <td><span class="status-badge status-${status}">${statusText}</span></td>`;
                    
                    if (currentUser.role === 'admin') {
                        html += `<td>
                            <button class="approve-btn" onclick="approveAttendance('${data.username}', '${data.date}')" ${data.approved || !data.checkOut ? 'disabled' : ''}>
                                <i class="fas fa-check me-1"></i>Setujui
                            </button>
                        </td>`;
                    }
                    
                    html += '</tr>';
                });
            }
            
            html += '</tbody></table>';
            document.getElementById('reportContent').innerHTML = html;
        }

        async function loadAllUserData(username) {
            let data = {};
            
            if (window.firebaseEnabled && window.firebaseDb) {
                try {
                    const { collection, query, where, getDocs } = window.firebaseModules;
                    const q = query(collection(window.firebaseDb, 'attendance'), where('username', '==', username));
                    const snap = await getDocs(q);
                    snap.forEach(doc => {
                        const d = doc.data();
                        data[d.date] = d;
                    });
                } catch (e) {
                    console.log('Firebase error:', e);
                }
            }
            
            if (Object.keys(data).length === 0) {
                data = JSON.parse(localStorage.getItem('attendance_' + username) || '{}');
            }
            
            return data;
        }

        async function approveAttendance(username, date) {
            if (window.firebaseEnabled && window.firebaseDb) {
                try {
                    const { doc, updateDoc } = window.firebaseModules;
                    await updateDoc(doc(window.firebaseDb, 'attendance', `${username}_${date}`), { 
                        approved: true,
                        approvedBy: currentUser.fullName,
                        approvedAt: new Date().toISOString()
                    });
                    showAlert('‚úÖ Absensi disetujui!', 'success');
                } catch (e) {
                    console.log('Firebase error, using local');
                    approveLocal(username, date);
                    showAlert('‚úÖ Absensi disetujui! (Local)', 'success');
                }
            } else {
                approveLocal(username, date);
                showAlert('‚úÖ Absensi disetujui! (Local)', 'success');
            }
            setTimeout(() => loadReports(), 500);
        }

        function approveLocal(username, date) {
            const local = JSON.parse(localStorage.getItem('attendance_' + username) || '{}');
            if (local[date]) {
                local[date].approved = true;
                local[date].approvedBy = currentUser.fullName;
                local[date].approvedAt = new Date().toISOString();
                localStorage.setItem('attendance_' + username, JSON.stringify(local));
            }
        }

        function exportReport() {
            const reportType = document.getElementById('reportType').value;
            const reportDate = document.getElementById('reportDate').value;
            const reportUser = document.getElementById('reportUser').value;
            
            let filename = `Laporan_Absensi_${reportType}_${reportDate}`;
            if (reportUser !== 'all') {
                filename += `_${reportUser}`;
            }
            
            const table = document.querySelector('.report-table');
            if (!table) {
                showAlert('Tidak ada data untuk diekspor', 'danger');
                return;
            }
            
            let csv = [];
            const rows = table.querySelectorAll('tr');
            
            rows.forEach(row => {
                const cols = row.querySelectorAll('td, th');
                const csvRow = [];
                cols.forEach((col, idx) => {
                    if (idx < cols.length - 1) {
                        csvRow.push('"' + col.textContent.replace(/"/g, '""') + '"');
                    }
                });
                csv.push(csvRow.join(','));
            });
            
            const csvContent = csv.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename + '.csv';
            link.click();
            
            showAlert('‚úÖ Report berhasil diexport!', 'success');
        }

        async function loadData(username, date) {
            if (window.firebaseEnabled && window.firebaseDb) {
                try {
                    const { doc, getDoc } = window.firebaseModules;
                    const docSnap = await getDoc(doc(window.firebaseDb, 'attendance', `${username}_${date}`));
                    return docSnap.exists() ? docSnap.data() : null;
                } catch (e) { console.log('Firebase error:', e); }
            }
            const local = JSON.parse(localStorage.getItem('attendance_' + username) || '{}');
            return local[date] || null;
        }

        async function loadHistory(username, elementId, limitCount) {
            let data = {};
            if (window.firebaseEnabled && window.firebaseDb) {
                try {
                    const { collection, query, where, orderBy, limit, getDocs } = window.firebaseModules;
                    const q = query(collection(window.firebaseDb, 'attendance'), where('username', '==', username), orderBy('date', 'desc'), limit(limitCount));
                    const snap = await getDocs(q);
                    snap.forEach(doc => { const d = doc.data(); data[d.date] = d; });
                } catch (e) { console.log('Firebase error:', e); }
            }
            if (Object.keys(data).length === 0) {
                data = JSON.parse(localStorage.getItem('attendance_' + username) || '{}');
            }
            
            const html = Object.keys(data).length === 0 ? '<p style="text-align: center; color: #999; padding: 2rem;">Belum ada riwayat</p>' :
                Object.keys(data).sort().reverse().slice(0, limitCount).map(date => {
                    const d = data[date];
                    const dateObj = new Date(date + 'T00:00:00');
                    const formatted = dateObj.toLocaleDateString('id-ID', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
                    return `<div style="padding: 1rem; border-bottom: 1px solid var(--beige); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; color: var(--forest);">${formatted}</div>
                            <span style="font-size: 0.85rem; color: ${d.checkOut ? '#666' : '#ef4444'};">${d.checkOut ? 'Durasi: ' + calcHours(d.checkIn, d.checkOut) : 'Belum Check Out'}</span>
                            ${d.distance ? `<div style="font-size: 0.75rem; color: #999; margin-top: 0.2rem;"><i class="fas fa-wifi me-1"></i>Jarak WiFi: ${d.distance}m</div>` : ''}
                            ${d.approved ? '<div style="margin-top: 0.3rem;"><span class="status-badge status-approved" style="font-size: 0.75rem;">Disetujui</span></div>' : ''}
                        </div>
                        <div style="display: flex; gap: 1rem; font-size: 0.9rem;">
                            <div><i class="fas fa-sign-in-alt" style="color: #10b981;"></i> ${d.checkIn || '-'}</div>
                            <div><i class="fas fa-sign-out-alt" style="color: #ef4444;"></i> ${d.checkOut || '-'}</div>
                        </div>
                    </div>`;
                }).join('');
            document.getElementById(elementId).innerHTML = html;
        }

        async function checkIn() {
            // Final validation check
            const isValid = await validateAttendanceConditions();
            
            if (!isValid) {
                showAlert('‚ùå Tidak dapat Check In! Pastikan WiFi dan lokasi sudah sesuai.', 'danger');
                return;
            }
            
            const distance = getDistance(
                currentLocation.lat, 
                currentLocation.lon, 
                GEOFENCE_CENTER.lat, 
                GEOFENCE_CENTER.lon
            );
            
            const now = new Date();
            const date = now.toISOString().split('T')[0];
            const time = now.toLocaleTimeString('id-ID');
            const data = { 
                username: currentUser.username, 
                fullName: currentUser.fullName, 
                date, 
                checkIn: time, 
                checkOut: null, 
                approved: false,
                location: currentLocation,
                distance: Math.round(distance)
            };
            
            if (window.firebaseEnabled && window.firebaseDb) {
                try {
                    const { doc, setDoc, serverTimestamp } = window.firebaseModules;
                    await setDoc(doc(window.firebaseDb, 'attendance', `${currentUser.username}_${date}`), { ...data, timestamp: serverTimestamp() });
                    showAlert('‚úÖ Check In berhasil! (Cloud)', 'success');
                } catch (e) {
                    console.log('Firebase error, using local');
                    saveLocal(data);
                    showAlert('‚úÖ Check In berhasil! (Local)', 'success');
                }
            } else {
                saveLocal(data);
                showAlert('‚úÖ Check In berhasil! (Local)', 'success');
            }
            setTimeout(() => loadAbsensi(currentUser), 1000);
        }

        async function checkOut() {
            // Final validation check
            const isValid = await validateAttendanceConditions();
            
            if (!isValid) {
                showAlert('‚ùå Tidak dapat Check Out! Pastikan WiFi dan lokasi sudah sesuai.', 'danger');
                return;
            }
            
            const distance = getDistance(
                currentLocation.lat, 
                currentLocation.lon, 
                GEOFENCE_CENTER.lat, 
                GEOFENCE_CENTER.lon
            );
            
            const now = new Date();
            const date = now.toISOString().split('T')[0];
            const time = now.toLocaleTimeString('id-ID');
            
            if (window.firebaseEnabled && window.firebaseDb) {
                try {
                    const { doc, updateDoc, serverTimestamp } = window.firebaseModules;
                    await updateDoc(doc(window.firebaseDb, 'attendance', `${currentUser.username}_${date}`), { 
                        checkOut: time, 
                        checkOutTimestamp: serverTimestamp(),
                        checkOutLocation: currentLocation,
                        checkOutDistance: Math.round(distance)
                    });
                    showAlert('‚úÖ Check Out berhasil! (Cloud)', 'success');
                } catch (e) {
                    console.log('Firebase error, using local');
                    updateLocal(date, time, distance);
                    showAlert('‚úÖ Check Out berhasil! (Local)', 'success');
                }
            } else {
                updateLocal(date, time, distance);
                showAlert('‚úÖ Check Out berhasil! (Local)', 'success');
            }
            setTimeout(() => loadAbsensi(currentUser), 1000);
        }

        function saveLocal(data) {
            const local = JSON.parse(localStorage.getItem('attendance_' + currentUser.username) || '{}');
            local[data.date] = data;
            localStorage.setItem('attendance_' + currentUser.username, JSON.stringify(local));
        }

        function updateLocal(date, time, distance) {
            const local = JSON.parse(localStorage.getItem('attendance_' + currentUser.username) || '{}');
            if (local[date]) {
                local[date].checkOut = time;
                local[date].checkOutLocation = currentLocation;
                local[date].checkOutDistance = Math.round(distance);
                localStorage.setItem('attendance_' + currentUser.username, JSON.stringify(local));
            }
        }

        function calcHours(checkIn, checkOut) {
            if (!checkIn || !checkOut) return '-';
            try {
                const [h1, m1] = checkIn.split(':').map(n => parseInt(n, 10));
                const [h2, m2] = checkOut.split(':').map(n => parseInt(n, 10));
                if (isNaN(h1) || isNaN(m1) || isNaN(h2) || isNaN(m2)) return '-';
                let diff = (h2 * 60 + m2) - (h1 * 60 + m1);
                if (diff < 0) diff += 24 * 60;
                return `${Math.floor(diff / 60)} jam ${diff % 60} menit`;
            } catch (e) { return '-'; }
        }

        function backToSelection() {
            stopValidationMonitoring();
            document.getElementById('absensiContainer').classList.remove('active');
            document.getElementById('appSelectionPage').classList.add('active');
            if (map) {
                map.remove();
                map = null;
            }
        }

        function showAlert(msg, type) {
            document.querySelectorAll('.alert-custom').forEach(el => el.remove());
            const div = document.createElement('div');
            div.className = `alert-custom alert-${type}`;
            div.innerHTML = `<div style="display: flex; align-items: center; justify-content: space-between;"><span><i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-triangle'} me-2"></i>${msg}</span><button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; color: inherit; cursor: pointer; padding: 0; margin-left: 1rem;"><i class="fas fa-times"></i></button></div>`;
            document.body.appendChild(div);
            setTimeout(() => { if (div.parentNode) div.remove(); }, 6000);
        }

        window.addEventListener('load', () => {
            setTimeout(() => {
                const saved = localStorage.getItem('pinuslo_user');
                if (saved) {
                    const user = JSON.parse(saved);
                    currentUser = user;
                    showAppSelection(user);
                }
                console.log('üöÄ Pinuslo Apps - Strict Validation System');
                console.log(window.firebaseEnabled ? '‚úÖ Firebase Connected' : '‚ö†Ô∏è Firebase Offline');
                console.log('');
                console.log('üîí VALIDASI KETAT - Check In/Out HANYA jika:');
                console.log('   1. Terhubung ke WiFi Cafepinuslo');
                console.log('   2. Dalam radius 50m dari titik WiFi');
                console.log('   3. Lokasi GPS aktif dan valid');
                console.log('');
                console.log('üìç WiFi Location:', GEOFENCE_CENTER.lat, GEOFENCE_CENTER.lon);
                console.log('üì∂ WiFi SSID:', REQUIRED_WIFI.ssid);
            }, 500);
        });
    </script>
</body>
</html>
