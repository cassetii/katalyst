<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#6e9726">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Pinuslo Apps - Management System</title>
    
    <!-- Preload Critical Resources -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://www.gstatic.com">
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <!-- Firebase SDK v9 (Modular) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, query, where, orderBy, limit, getDocs, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyB8X3i-YHCqYiki4hkBxHNk26Af5qQOfjM",
            authDomain: "drmd-2c6da.firebaseapp.com",
            projectId: "drmd-2c6da",
            storageBucket: "drmd-2c6da.firebasestorage.app",
            messagingSenderId: "656840700301",
            appId: "1:656840700301:web:ba79742f91c13388100dc4",
            measurementId: "G-XGJ7ZNQKB9"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const analytics = getAnalytics(app);
            console.log('✅ Firebase connected - DRMD Project');
            window.firebaseDb = db;
            window.firebaseAnalytics = analytics;
            window.firebaseEnabled = true;
            window.firebaseModules = { collection, doc, setDoc, getDoc, updateDoc, query, where, orderBy, limit, getDocs, serverTimestamp };
            window.serverTimestamp = serverTimestamp;
        } catch (error) {
            console.error('❌ Firebase failed:', error);
            window.firebaseEnabled = false;
        }
    </script>
    
    <style>
        /* ========================================
           MOBILE-FIRST CSS VARIABLES & RESET
        ======================================== */
        :root {
            /* Color Palette */
            --cream: #F5F5F0;
            --beige: #E6D8C3;
            --tan: #C2A68C;
            --forest: #5D866C;
            --pine-green: #6e9726;
            --sage-green: #7d8b70;
            --dark-forest: #465c35;
            
            /* Spacing System (Mobile-First) */
            --spacing-xs: 0.5rem;
            --spacing-sm: 0.75rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            
            /* Typography Scale */
            --font-xs: 0.75rem;
            --font-sm: 0.875rem;
            --font-base: 1rem;
            --font-lg: 1.125rem;
            --font-xl: 1.25rem;
            --font-2xl: 1.5rem;
            --font-3xl: 2rem;
            
            /* Mobile Touch Targets */
            --touch-target: 44px;
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 20px rgba(0,0,0,0.15);
            
            /* Z-index Scale */
            --z-base: 1;
            --z-header: 100;
            --z-modal: 1000;
            --z-toast: 2000;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
            background: var(--cream);
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* ========================================
           MOBILE NAVIGATION (Bottom Tab Bar)
           Following Jakob's Law - Familiar Pattern
        ======================================== */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: var(--spacing-xs) 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: var(--z-header);
            border-top: 1px solid #e5e7eb;
        }
        
        .mobile-nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: var(--spacing-xs);
            color: #9ca3af;
            text-decoration: none;
            transition: all 0.2s ease;
            cursor: pointer;
            min-height: var(--touch-target);
            justify-content: center;
        }
        
        .mobile-nav-item.active {
            color: var(--pine-green);
        }
        
        .mobile-nav-item i {
            font-size: 1.5rem;
        }
        
        .mobile-nav-item span {
            font-size: var(--font-xs);
            font-weight: 500;
        }
        
        /* ========================================
           MOBILE HEADER (Top Bar)
        ======================================== */
        .mobile-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            padding: var(--spacing-md);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
            z-index: var(--z-header);
            min-height: 56px;
        }
        
        .mobile-header-title {
            font-size: var(--font-lg);
            font-weight: 700;
            color: var(--dark-forest);
        }
        
        .mobile-header-back {
            width: var(--touch-target);
            height: var(--touch-target);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: var(--cream);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .mobile-header-back:active {
            transform: scale(0.95);
            background: var(--beige);
        }
        
        /* ========================================
           LOGIN PAGE - MOBILE OPTIMIZED
        ======================================== */
        .login-page {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, var(--dark-forest) 0%, var(--sage-green) 50%, var(--pine-green) 100%);
            position: relative;
            overflow: hidden;
            padding: var(--spacing-lg);
        }
        
        .login-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            z-index: var(--z-base);
        }
        
        .login-logo {
            width: 120px;
            height: 120px;
            margin: 0 auto var(--spacing-lg);
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            padding: var(--spacing-xl);
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .login-title {
            font-size: var(--font-2xl);
            font-weight: 700;
            color: var(--dark-forest);
            text-align: center;
            margin-bottom: var(--spacing-sm);
        }
        
        .login-subtitle {
            font-size: var(--font-sm);
            color: var(--sage-green);
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }
        
        .input-group {
            position: relative;
            margin-bottom: var(--spacing-lg);
        }
        
        .input-group input {
            width: 100%;
            height: var(--touch-target);
            padding: 0 var(--spacing-md) 0 3rem;
            border: 2px solid #e5e7eb;
            border-radius: var(--radius-md);
            font-size: var(--font-base);
            transition: all 0.2s ease;
            background: white;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--pine-green);
            box-shadow: 0 0 0 3px rgba(110, 151, 38, 0.1);
        }
        
        .input-icon {
            position: absolute;
            left: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--sage-green);
            font-size: var(--font-lg);
            pointer-events: none;
        }
        
        .input-toggle {
            position: absolute;
            right: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            color: var(--sage-green);
            cursor: pointer;
            padding: var(--spacing-xs);
        }
        
        .btn-primary {
            width: 100%;
            height: var(--touch-target);
            background: linear-gradient(135deg, var(--pine-green), var(--dark-forest));
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-base);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary:active {
            transform: scale(0.98);
            box-shadow: var(--shadow-sm);
        }
        
        /* ========================================
           APP SELECTION - CARD GRID
        ======================================== */
        .app-page {
            padding-top: 56px;
            padding-bottom: 70px;
            min-height: 100vh;
        }
        
        .user-profile {
            background: white;
            margin: var(--spacing-md);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            box-shadow: var(--shadow-sm);
        }
        
        .user-avatar {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--pine-green), var(--dark-forest));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: var(--font-2xl);
            font-weight: 700;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-size: var(--font-lg);
            font-weight: 700;
            color: var(--dark-forest);
            margin-bottom: 2px;
        }
        
        .user-role {
            font-size: var(--font-sm);
            color: var(--sage-green);
        }
        
        .apps-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
            padding: 0 var(--spacing-md) var(--spacing-md);
        }
        
        .app-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: var(--spacing-sm);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
            cursor: pointer;
            min-height: 140px;
            justify-content: center;
        }
        
        .app-card:active {
            transform: scale(0.97);
            box-shadow: var(--shadow-md);
        }
        
        .app-icon {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-2xl);
            color: white;
            margin-bottom: var(--spacing-xs);
        }
        
        .app-card.pinus .app-icon {
            background: linear-gradient(135deg, var(--pine-green), var(--dark-forest));
        }
        
        .app-card.pinewater .app-icon {
            background: linear-gradient(135deg, #0891b2, #06b6d4);
        }
        
        .app-card.bbm .app-icon {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }
        
        .app-card.cafe .app-icon {
            background: linear-gradient(135deg, #dc2626, #991b1b);
        }
        
        .app-card.glamping .app-icon {
            background: linear-gradient(135deg, #ea580c, #c2410c);
        }
        
        .app-card.absensi .app-icon {
            background: linear-gradient(135deg, #a855f7, #9333ea);
        }
        
        .app-name {
            font-size: var(--font-base);
            font-weight: 700;
            color: var(--dark-forest);
        }
        
        .app-desc {
            font-size: var(--font-xs);
            color: var(--sage-green);
            line-height: 1.4;
        }
        
        /* ========================================
           ABSENSI - MOBILE OPTIMIZED
        ======================================== */
        .absensi-page {
            padding-top: 56px;
            padding-bottom: 70px;
            min-height: 100vh;
        }
        
        .location-selector {
            background: white;
            margin: var(--spacing-md);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }
        
        .location-title {
            font-size: var(--font-base);
            font-weight: 700;
            color: var(--dark-forest);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .location-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--spacing-sm);
        }
        
        .location-btn {
            padding: var(--spacing-md);
            border: 2px solid #e5e7eb;
            border-radius: var(--radius-md);
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }
        
        .location-btn.active {
            border-color: var(--pine-green);
            background: linear-gradient(135deg, rgba(110, 151, 38, 0.1), rgba(70, 92, 53, 0.1));
        }
        
        .location-btn:active {
            transform: scale(0.98);
        }
        
        .location-btn i {
            font-size: var(--font-2xl);
            color: var(--pine-green);
        }
        
        .location-info h4 {
            font-size: var(--font-base);
            font-weight: 700;
            color: var(--dark-forest);
            margin-bottom: 2px;
        }
        
        .location-info p {
            font-size: var(--font-xs);
            color: var(--sage-green);
            margin: 0;
        }
        
        .status-card {
            background: white;
            margin: 0 var(--spacing-md) var(--spacing-md);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }
        
        .status-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }
        
        .status-header i {
            font-size: var(--font-xl);
        }
        
        .status-header h3 {
            font-size: var(--font-lg);
            font-weight: 700;
            color: var(--dark-forest);
            margin: 0;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
        }
        
        .status-item.success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-item.error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status-item.warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-item i {
            font-size: var(--font-xl);
        }
        
        .status-content {
            flex: 1;
        }
        
        .status-content strong {
            display: block;
            margin-bottom: 2px;
        }
        
        .status-content small {
            font-size: var(--font-xs);
            opacity: 0.9;
        }
        
        #map {
            height: 200px;
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
        }
        
        .time-display {
            text-align: center;
            padding: var(--spacing-xl) var(--spacing-md);
        }
        
        #clock {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--dark-forest);
            font-family: 'SF Mono', 'Monaco', monospace;
            margin-bottom: var(--spacing-xs);
        }
        
        #date {
            font-size: var(--font-sm);
            color: var(--sage-green);
        }
        
        .attendance-info {
            background: var(--cream);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--beige);
        }
        
        .info-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .info-label {
            font-size: var(--font-sm);
            color: #666;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .info-value {
            font-size: var(--font-base);
            font-weight: 700;
            color: var(--dark-forest);
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--spacing-sm);
            padding: 0 var(--spacing-md) var(--spacing-md);
        }
        
        .btn-check-in {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: var(--font-base);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }
        
        .btn-check-in:active:not(:disabled) {
            transform: scale(0.98);
        }
        
        .btn-check-in:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-check-out {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: var(--font-base);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }
        
        .btn-check-out:active:not(:disabled) {
            transform: scale(0.98);
        }
        
        .btn-check-out:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-refresh {
            background: linear-gradient(135deg, #0891b2, #06b6d4);
            color: white;
            border: none;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: var(--font-base);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }
        
        .btn-refresh:active {
            transform: scale(0.98);
        }
        
        /* ========================================
           HISTORY VIEW
        ======================================== */
        .history-list {
            padding: 0 var(--spacing-md) var(--spacing-md);
        }
        
        .history-item {
            background: white;
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
            box-shadow: var(--shadow-sm);
        }
        
        .history-date {
            font-size: var(--font-sm);
            font-weight: 700;
            color: var(--dark-forest);
            margin-bottom: var(--spacing-xs);
        }
        
        .history-times {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--spacing-xs);
        }
        
        .time-badge {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: var(--font-xs);
        }
        
        .time-badge.in {
            color: #10b981;
        }
        
        .time-badge.out {
            color: #ef4444;
        }
        
        .history-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--font-xs);
            color: #666;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: var(--font-xs);
            font-weight: 600;
        }
        
        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-incomplete {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* ========================================
           REPORTS VIEW (ADMIN)
        ======================================== */
        .filter-bar {
            background: white;
            margin: var(--spacing-md);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }
        
        .filter-group {
            margin-bottom: var(--spacing-md);
        }
        
        .filter-group:last-child {
            margin-bottom: 0;
        }
        
        .filter-label {
            font-size: var(--font-sm);
            font-weight: 600;
            color: var(--dark-forest);
            margin-bottom: var(--spacing-xs);
            display: block;
        }
        
        .filter-input {
            width: 100%;
            height: var(--touch-target);
            padding: 0 var(--spacing-md);
            border: 2px solid #e5e7eb;
            border-radius: var(--radius-md);
            font-size: var(--font-base);
        }
        
        .filter-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-sm);
        }
        
        .btn-filter {
            background: var(--pine-green);
            color: white;
            border: none;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: var(--font-sm);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
        }
        
        .btn-export {
            background: #0891b2;
            color: white;
            border: none;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            font-size: var(--font-sm);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-xs);
        }
        
        .report-item {
            background: white;
            margin: 0 var(--spacing-md) var(--spacing-sm);
            padding: var(--spacing-lg);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-sm);
        }
        
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid #e5e7eb;
        }
        
        .report-user {
            flex: 1;
        }
        
        .report-user h4 {
            font-size: var(--font-base);
            font-weight: 700;
            color: var(--dark-forest);
            margin-bottom: 2px;
        }
        
        .report-user p {
            font-size: var(--font-xs);
            color: var(--sage-green);
            margin: 0;
        }
        
        .report-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }
        
        .detail-item {
            font-size: var(--font-xs);
        }
        
        .detail-label {
            color: #666;
            display: block;
            margin-bottom: 2px;
        }
        
        .detail-value {
            font-weight: 700;
            color: var(--dark-forest);
        }
        
        .report-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-sm);
        }
        
        .btn-approve {
            background: #10b981;
            color: white;
            border: none;
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: var(--font-sm);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .btn-approve:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-reject {
            background: #ef4444;
            color: white;
            border: none;
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: var(--font-sm);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .btn-reject:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .rejection-reason {
            background: #fee2e2;
            color: #991b1b;
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: var(--font-xs);
            margin-top: var(--spacing-sm);
            border-left: 3px solid #dc2626;
        }
        
        /* ========================================
           MODAL (Bottom Sheet Style)
        ======================================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: var(--z-modal);
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-overlay.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            padding: var(--spacing-xl);
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUpModal 0.3s ease;
            z-index: calc(var(--z-modal) + 1);
        }
        
        @keyframes slideUpModal {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }
        
        .modal-handle {
            width: 40px;
            height: 4px;
            background: #d1d5db;
            border-radius: 2px;
            margin: 0 auto var(--spacing-lg);
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        
        .modal-header i {
            font-size: var(--font-2xl);
            color: #ef4444;
        }
        
        .modal-header h3 {
            font-size: var(--font-lg);
            font-weight: 700;
            color: var(--dark-forest);
            margin: 0;
        }
        
        .modal-body {
            margin-bottom: var(--spacing-lg);
        }
        
        .modal-label {
            font-size: var(--font-sm);
            font-weight: 600;
            color: var(--dark-forest);
            margin-bottom: var(--spacing-sm);
            display: block;
        }
        
        .modal-textarea {
            width: 100%;
            min-height: 120px;
            padding: var(--spacing-md);
            border: 2px solid #e5e7eb;
            border-radius: var(--radius-md);
            font-size: var(--font-base);
            font-family: inherit;
            resize: vertical;
        }
        
        .modal-textarea:focus {
            outline: none;
            border-color: var(--pine-green);
            box-shadow: 0 0 0 3px rgba(110, 151, 38, 0.1);
        }
        
        .modal-footer {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-sm);
        }
        
        .btn-modal-cancel {
            padding: var(--spacing-md);
            background: var(--cream);
            color: var(--dark-forest);
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-base);
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-modal-submit {
            padding: var(--spacing-md);
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-base);
            font-weight: 600;
            cursor: pointer;
        }
        
        /* ========================================
           TOAST NOTIFICATIONS
        ======================================== */
        .toast {
            position: fixed;
            top: var(--spacing-md);
            left: var(--spacing-md);
            right: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: var(--z-toast);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .toast.success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .toast.error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .toast.warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .toast i {
            font-size: var(--font-lg);
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: var(--spacing-xs);
        }
        
        /* ========================================
           UTILITY CLASSES
        ======================================== */
        .page-section {
            display: none;
        }
        
        .page-section.active {
            display: block;
        }
        
        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: #9ca3af;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.5;
        }
        
        .empty-state p {
            font-size: var(--font-sm);
        }
        
        /* ========================================
           LOADING STATES
        ======================================== */
        .skeleton {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: var(--radius-sm);
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ========================================
           RESPONSIVE DESIGN
        ======================================== */
        @media (min-width: 768px) {
            .apps-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .login-card {
                max-width: 400px;
                margin: 0 auto;
            }
            
            .mobile-nav {
                display: none;
            }
        }
        
        @media (min-width: 1024px) {
            .apps-grid {
                grid-template-columns: repeat(4, 1fr);
                max-width: 1200px;
                margin: 0 auto;
                padding: var(--spacing-xl);
            }
            
            .status-card,
            .location-selector,
            .user-profile {
                max-width: 800px;
                margin-left: auto;
                margin-right: auto;
            }
        }
        
        /* ========================================
           ACCESSIBILITY & DARK MODE PREP
        ======================================== */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Focus visible for keyboard navigation */
        *:focus-visible {
            outline: 2px solid var(--pine-green);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <!-- ============================================
         LOGIN PAGE
    ============================================ -->
    <div id="loginPage" class="page-section active">
        <div class="login-page">
            <div class="login-content">
                <div class="login-logo">
                    <svg viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="250" cy="250" r="220" fill="#465c35"/>
                        <ellipse cx="250" cy="300" rx="180" ry="30" fill="#7d8b70"/>
                        <path d="M 70 300 Q 250 280, 430 300" stroke="#6e9726" stroke-width="3" fill="none"/>
                        <rect x="160" y="260" width="8" height="40" fill="#ffffff" rx="2"/>
                        <rect x="245" y="240" width="10" height="60" fill="#ffffff" rx="2"/>
                        <rect x="335" y="260" width="8" height="40" fill="#ffffff" rx="2"/>
                        <g transform="translate(171, 200)">
                            <rect x="-6" y="0" width="12" height="60" fill="#465c35"/>
                            <path d="M 0 10 L -16 25 L 16 25 Z" fill="#5a7047"/>
                            <path d="M 0 0 L -21 20 L 21 20 Z" fill="#6e9726"/>
                            <path d="M 0 -10 L -26 15 L 26 15 Z" fill="#7da030"/>
                        </g>
                        <g transform="translate(252, 160)">
                            <rect x="-7.5" y="0" width="15" height="80" fill="#465c35"/>
                            <path d="M 0 20 L -22 40 L 22 40 Z" fill="#5a7047"/>
                            <path d="M 0 8 L -32 35 L 32 35 Z" fill="#5a7047"/>
                            <path d="M 0 -4 L -42 30 L 42 30 Z" fill="#6e9726"/>
                            <path d="M 0 -16 L -47 20 L 47 20 Z" fill="#7da030"/>
                        </g>
                        <g transform="translate(336, 200)">
                            <rect x="-6" y="0" width="12" height="60" fill="#465c35"/>
                            <path d="M 0 10 L -16 25 L 16 25 Z" fill="#5a7047"/>
                            <path d="M 0 0 L -21 20 L 21 20 Z" fill="#6e9726"/>
                            <path d="M 0 -10 L -26 15 L 26 15 Z" fill="#7da030"/>
                        </g>
                        <text x="250" y="345" font-family="Arial, sans-serif" font-size="48" font-weight="bold" text-anchor="middle" fill="#ffffff" letter-spacing="8">PINUSLO</text>
                        <text x="250" y="370" font-family="Arial, sans-serif" font-size="14" text-anchor="middle" fill="#ffffff" letter-spacing="2">Camping Feels Like Home</text>
                    </svg>
                </div>
                
                <div class="login-card">
                    <h2 class="login-title">Selamat Datang</h2>
                    <p class="login-subtitle">Silakan masuk untuk melanjutkan</p>
                    
                    <form id="loginForm">
                        <div class="input-group">
                            <i class="fas fa-user input-icon"></i>
                            <input type="text" id="username" placeholder="Username" required autocomplete="username">
                        </div>
                        
                        <div class="input-group">
                            <i class="fas fa-lock input-icon"></i>
                            <input type="password" id="password" placeholder="Password" required autocomplete="current-password">
                            <i class="fas fa-eye input-toggle" id="passwordToggle"></i>
                        </div>
                        
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-sign-in-alt"></i>
                            <span>Masuk</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================
         APP SELECTION PAGE
    ============================================ -->
    <div id="appSelectionPage" class="page-section">
        <div class="app-page">
            <div class="mobile-header">
                <h1 class="mobile-header-title">Pinuslo Apps</h1>
            </div>
            
            <div class="user-profile">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-info">
                    <div class="user-name" id="userName">User</div>
                    <div class="user-role" id="userRole">Staff</div>
                </div>
            </div>
            
            <div class="apps-grid" id="appsGrid">
                <!-- Apps will be dynamically generated -->
            </div>
        </div>
        
        <nav class="mobile-nav">
            <div class="mobile-nav-item active">
                <i class="fas fa-home"></i>
                <span>Beranda</span>
            </div>
            <div class="mobile-nav-item" onclick="handleLogout()">
                <i class="fas fa-sign-out-alt"></i>
                <span>Keluar</span>
            </div>
        </nav>
    </div>

    <!-- ============================================
         ABSENSI PAGE
    ============================================ -->
    <div id="absensiPage" class="page-section">
        <div class="absensi-page">
            <div class="mobile-header">
                <div class="mobile-header-back" onclick="backToSelection()">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <h1 class="mobile-header-title">Absensi</h1>
            </div>
            
            <!-- Location Selector -->
            <div class="location-selector">
                <div class="location-title">
                    <i class="fas fa-map-marker-alt"></i>
                    <span>Pilih Lokasi Absensi</span>
                </div>
                <div class="location-options">
                    <button class="location-btn active" onclick="switchLocation('pinuslo')" id="locBtn_pinuslo">
                        <i class="fas fa-tree"></i>
                        <div class="location-info">
                            <h4>Kawasan Pinuslo</h4>
                            <p>WiFi: Cafepinuslo</p>
                        </div>
                    </button>
                    <button class="location-btn" onclick="switchLocation('testing')" id="locBtn_testing">
                        <i class="fas fa-vial"></i>
                        <div class="location-info">
                            <h4>Kawasan Testing</h4>
                            <p>WiFi: Div--SIMO_5G</p>
                        </div>
                    </button>
                </div>
            </div>
            
            <!-- Status Cards -->
            <div class="status-card">
                <div class="status-header">
                    <i class="fas fa-wifi"></i>
                    <h3>Status Koneksi</h3>
                </div>
                <div id="wifiStatus" class="status-item warning">
                    <i class="fas fa-spinner fa-spin"></i>
                    <div class="status-content">
                        <strong>Memeriksa WiFi...</strong>
                        <small>Mohon tunggu</small>
                    </div>
                </div>
                <div id="locationStatus" class="status-item warning">
                    <i class="fas fa-spinner fa-spin"></i>
                    <div class="status-content">
                        <strong>Mendapatkan Lokasi...</strong>
                        <small>Mohon tunggu</small>
                    </div>
                </div>
                <div id="map"></div>
                <button class="btn-refresh" onclick="refreshLocation()">
                    <i class="fas fa-sync-alt"></i>
                    <span>Refresh Lokasi & WiFi</span>
                </button>
            </div>
            
            <!-- Time & Attendance Info -->
            <div class="status-card">
                <div class="time-display">
                    <div id="clock">00:00:00</div>
                    <div id="date">Loading...</div>
                </div>
                
                <div class="attendance-info" id="attendanceInfo">
                    <!-- Attendance info will be dynamically generated -->
                </div>
                
                <div class="action-buttons">
                    <button class="btn-check-in" id="checkInBtn" onclick="checkIn()" disabled>
                        <i class="fas fa-sign-in-alt"></i>
                        <span>Check In</span>
                    </button>
                    <button class="btn-check-out" id="checkOutBtn" onclick="checkOut()" disabled>
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Check Out</span>
                    </button>
                </div>
            </div>
            
            <!-- History Section -->
            <div class="status-card">
                <div class="status-header">
                    <i class="fas fa-history"></i>
                    <h3>Riwayat Absensi</h3>
                </div>
                <div class="history-list" id="historyList">
                    <!-- History will be dynamically generated -->
                </div>
            </div>
        </div>
        
        <nav class="mobile-nav">
            <div class="mobile-nav-item active" onclick="switchAbsensiView('check')">
                <i class="fas fa-fingerprint"></i>
                <span>Absensi</span>
            </div>
            <div class="mobile-nav-item" onclick="switchAbsensiView('history')">
                <i class="fas fa-history"></i>
                <span>Riwayat</span>
            </div>
            <div class="mobile-nav-item" onclick="switchAbsensiView('reports')" id="navReports" style="display: none;">
                <i class="fas fa-chart-bar"></i>
                <span>Laporan</span>
            </div>
        </nav>
    </div>

    <!-- ============================================
         REPORTS PAGE (ADMIN)
    ============================================ -->
    <div id="reportsPage" class="page-section">
        <div class="absensi-page">
            <div class="mobile-header">
                <div class="mobile-header-back" onclick="backToAbsensi()">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <h1 class="mobile-header-title">Laporan Absensi</h1>
            </div>
            
            <div class="filter-bar">
                <div class="filter-group">
                    <label class="filter-label">Tipe Laporan</label>
                    <select id="reportType" class="filter-input">
                        <option value="daily">Harian</option>
                        <option value="weekly">Mingguan</option>
                        <option value="monthly">Bulanan</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Tanggal</label>
                    <input type="date" id="reportDate" class="filter-input">
                </div>
                <div class="filter-actions">
                    <button class="btn-filter" onclick="loadReports()">
                        <i class="fas fa-search"></i>
                        <span>Filter</span>
                    </button>
                    <button class="btn-export" onclick="exportReport()">
                        <i class="fas fa-download"></i>
                        <span>Export</span>
                    </button>
                </div>
            </div>
            
            <div id="reportsList">
                <!-- Reports will be dynamically generated -->
            </div>
        </div>
        
        <nav class="mobile-nav">
            <div class="mobile-nav-item" onclick="backToAbsensi()">
                <i class="fas fa-fingerprint"></i>
                <span>Absensi</span>
            </div>
            <div class="mobile-nav-item" onclick="switchAbsensiView('history')">
                <i class="fas fa-history"></i>
                <span>Riwayat</span>
            </div>
            <div class="mobile-nav-item active">
                <i class="fas fa-chart-bar"></i>
                <span>Laporan</span>
            </div>
        </nav>
    </div>

    <!-- ============================================
         REJECT MODAL (Bottom Sheet)
    ============================================ -->
    <div id="rejectModal" class="modal-overlay">
        <div class="modal-sheet">
            <div class="modal-handle"></div>
            <div class="modal-header">
                <i class="fas fa-times-circle"></i>
                <div>
                    <h3>Tolak Absensi</h3>
                    <p id="rejectModalUser" style="font-size: 0.875rem; color: #7d8b70; margin: 0;"></p>
                </div>
            </div>
            <div class="modal-body">
                <label class="modal-label">
                    Alasan Penolakan <span style="color: #ef4444;">*</span>
                </label>
                <textarea id="rejectionReason" class="modal-textarea" placeholder="Masukkan alasan penolakan..." required></textarea>
                <p style="font-size: 0.75rem; color: #666; margin-top: 0.5rem;">
                    <i class="fas fa-info-circle"></i> Karyawan akan melihat alasan ini
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-cancel" onclick="closeRejectModal()">
                    <i class="fas fa-times"></i> Batal
                </button>
                <button class="btn-modal-submit" onclick="confirmRejectAttendance()">
                    <i class="fas fa-ban"></i> Tolak
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // GLOBAL VARIABLES & CONFIGURATION
        // ============================================
        let currentUser = null;
        let map = null;
        let userMarker = null;
        let currentLocation = null;
        let geofenceCircle = null;
        let validationInterval = null;
        let isValidForAttendance = false;
        let currentRejectData = null;
        let selectedLocation = 'pinuslo';

        const LOCATIONS = {
            pinuslo: {
                name: "Kawasan Pinuslo",
                center: { lat: -5.367065295968101, lon: 119.6489802711651 },
                radius: 500,
                wifi: {
                    ssid: "Cafepinuslo",
                    bssid: "96:3c:80:6a:83:6d",
                    security: "WPA2/WP3 Personal"
                }
            },
            testing: {
                name: "Kawasan Testing",
                center: { lat: -5.150256854076427, lon: 119.41546986471782 },
                radius: 500,
                wifi: {
                    ssid: "Div--SIMO_5G",
                    bssid: null,
                    security: "WPA2/WP3 Personal"
                }
            }
        };

        let GEOFENCE_CENTER = LOCATIONS[selectedLocation].center;
        let GEOFENCE_RADIUS = LOCATIONS[selectedLocation].radius;
        let REQUIRED_WIFI = LOCATIONS[selectedLocation].wifi;

        const allUsers = [
            { username: 'iqbal', password: 'iqbal123', role: 'admin', fullName: 'Iqbal', apps: ['pinus', 'pinewater', 'bbm', 'cafe', 'glamping', 'absensi'] },
            { username: 'jendra', password: 'jendra123', role: 'admin', fullName: 'Jendra', apps: ['cafe', 'absensi'] },
            { username: 'selow', password: 'selow123', role: 'admin', fullName: 'Selow', apps: ['pinus', 'pinewater', 'absensi'] },
            { username: 'komandan', password: 'komandan123', role: 'admin', fullName: 'Komandan', apps: ['pinewater', 'bbm', 'absensi'] },
            { username: 'agus', password: 'agus123', role: 'user', fullName: 'Agus', apps: ['pinus', 'cafe', 'glamping', 'absensi'] },
            { username: 'selfi', password: 'selfi123', role: 'user', fullName: 'Selfi', apps: ['pinus', 'cafe', 'glamping', 'absensi'] },
            { username: 'fadel', password: 'fadel123', role: 'user', fullName: 'Fadel', apps: ['cafe', 'absensi'] },
            { username: 'farel', password: 'farel123', role: 'user', fullName: 'Farel', apps: ['cafe', 'absensi'] },
            { username: 'sadiq', password: 'sadiq123', role: 'user', fullName: 'Sadiq', apps: ['cafe', 'absensi'] },
            { username: 'sirad', password: 'sirad123', role: 'user', fullName: 'Sirad', apps: ['pinus', 'pinewater', 'cafe', 'glamping', 'absensi'] },
            { username: 'bate', password: 'bate123', role: 'user', fullName: 'Bate', apps: ['pinus', 'cafe', 'absensi'] },
            { username: 'zulkifli', password: 'zulkifli123', role: 'user', fullName: 'Zulkifli', apps: ['pinus', 'pinewater', 'absensi'] },
            { username: 'ikki', password: 'ikki123', role: 'user', fullName: 'Ikki', apps: ['pinus', 'cafe', 'absensi'] },
            { username: 'chulo', password: 'chulo123', role: 'user', fullName: 'Chulo', apps: ['glamping'] },
            { username: 'pian', password: 'pian123', role: 'user', fullName: 'Pian', apps: ['glamping'] },
            { username: 'imbang', password: 'imbang123', role: 'user', fullName: 'Imbang', apps: ['glamping'] },
            { username: 'babal', password: 'babal123', role: 'user', fullName: 'Babal', apps: ['glamping', 'pinewater'] },
            { username: 'roy', password: 'roy123', role: 'user', fullName: 'Roy', apps: ['pinewater', 'glamping'] }
        ];

        const appUrls = {
            'pinus': 'https://pinusselowregist.netlify.app',
            'pinewater': 'https://pinewater.netlify.app',
            'bbm': 'https://pinebbm.netlify.app',
            'cafe': 'https://pinuslocafe.netlify.app',
            'glamping': 'https://pinusloglamping.netlify.app/'
        };

        const appConfig = {
            'pinus': { name: 'Pinus Selow Regist', icon: 'fa-tree', desc: 'Sistem Pendaftaran & Manajemen Pinus' },
            'pinewater': { name: 'Pinewater', icon: 'fa-water', desc: 'Sistem Manajemen Air & Distribusi' },
            'bbm': { name: 'BBM Management', icon: 'fa-gas-pump', desc: 'Sistem Manajemen Bahan Bakar' },
            'cafe': { name: 'Pinuslo Cafe', icon: 'fa-coffee', desc: 'Sistem Manajemen Cafe & POS' },
            'glamping': { name: 'Pinuslo Glamping', icon: 'fa-campground', desc: 'Sistem Reservasi Glamping' },
            'absensi': { name: 'Absensi', icon: 'fa-fingerprint', desc: 'Sistem Absensi Karyawan' }
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) + 
                     Math.cos(φ1) * Math.cos(φ2) * 
                     Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function isInGeofence(lat, lon) {
            const distance = getDistance(lat, lon, GEOFENCE_CENTER.lat, GEOFENCE_CENTER.lon);
            return distance <= GEOFENCE_RADIUS;
        }

        function calculateWorkingHours(checkInTime, checkOutTime) {
            if (!checkInTime || !checkOutTime) return '-';
            
            try {
                const parseTime = (timeStr) => {
                    const parts = timeStr.replace(/\./g, ':').split(':');
                    return {
                        hours: parseInt(parts[0], 10),
                        minutes: parseInt(parts[1], 10),
                        seconds: parts.length > 2 ? parseInt(parts[2], 10) : 0
                    };
                };
                
                const checkIn = parseTime(checkInTime);
                const checkOut = parseTime(checkOutTime);
                
                if (isNaN(checkIn.hours) || isNaN(checkIn.minutes) || 
                    isNaN(checkOut.hours) || isNaN(checkOut.minutes)) {
                    return '-';
                }
                
                const checkInMinutes = checkIn.hours * 60 + checkIn.minutes + (checkIn.seconds / 60);
                let checkOutMinutes = checkOut.hours * 60 + checkOut.minutes + (checkOut.seconds / 60);
                
                if (checkOutMinutes < checkInMinutes) {
                    checkOutMinutes += 24 * 60;
                }
                
                const diffMinutes = Math.round(checkOutMinutes - checkInMinutes);
                const hours = Math.floor(diffMinutes / 60);
                const minutes = diffMinutes % 60;
                
                if (hours === 0) {
                    return minutes + ' menit';
                } else if (minutes === 0) {
                    return hours + ' jam';
                } else {
                    return hours + ' jam ' + minutes + ' menit';
                }
            } catch (error) {
                console.error('Error calculating hours:', error);
                return '-';
            }
        }

        function showToast(message, type) {
            if (type === void 0) { type = 'success'; }
            
            // Remove existing toasts
            document.querySelectorAll('.toast').forEach(function(el) { 
                el.remove(); 
            });
            
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            
            const icon = type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-triangle' : 
                        'fa-info-circle';
            
            toast.innerHTML = '<i class="fas ' + icon + '"></i><div class="toast-content">' + message + '</div><button class="toast-close" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>';
            
            document.body.appendChild(toast);
            
            setTimeout(function() {
                if (toast.parentElement) toast.remove();
            }, 5000);
        }

        // ============================================
        // AUTHENTICATION
        // ============================================
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                
                const user = allUsers.find(function(u) { 
                    return u.username === username && u.password === password; 
                });
                
                if (user) {
                    currentUser = user;
                    localStorage.setItem('pinuslo_user', JSON.stringify(user));
                    showToast('Selamat datang, ' + user.fullName + '!', 'success');
                    setTimeout(function() { 
                        showAppSelection(user); 
                    }, 500);
                } else {
                    showToast('Username atau password salah!', 'error');
                }
            });
        }

        // Toggle password visibility
        const passwordToggle = document.getElementById('passwordToggle');
        if (passwordToggle) {
            passwordToggle.addEventListener('click', function() {
                const passwordInput = document.getElementById('password');
                const icon = this;
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
        }

        function showAppSelection(user) {
            // Hide login page
            document.getElementById('loginPage').classList.remove('active');
            document.getElementById('appSelectionPage').classList.add('active');
            
            // Update user info
            document.getElementById('userAvatar').textContent = user.fullName.charAt(0).toUpperCase();
            document.getElementById('userName').textContent = user.fullName;
            document.getElementById('userRole').textContent = user.role === 'admin' ? 'Administrator' : 'Staff';
            
            // Generate app cards
            const appsGrid = document.getElementById('appsGrid');
            appsGrid.innerHTML = '';
            
            Object.keys(appConfig).forEach(function(appKey) {
                if (user.apps.includes(appKey)) {
                    const app = appConfig[appKey];
                    const card = document.createElement('div');
                    card.className = 'app-card ' + appKey;
                    card.innerHTML = '<div class="app-icon"><i class="fas ' + app.icon + '"></i></div><div class="app-name">' + app.name + '</div><div class="app-desc">' + app.desc + '</div>';
                    
                    card.addEventListener('click', function() {
                        if (appKey === 'absensi') {
                            loadAbsensi(user);
                        } else if (appUrls[appKey]) {
                            showToast('Membuka ' + app.name + '...', 'success');
                            setTimeout(function() { 
                                window.open(appUrls[appKey], '_blank'); 
                            }, 500);
                        }
                    });
                    
                    appsGrid.appendChild(card);
                }
            });
        }

        function handleLogout() {
            if (confirm('Yakin ingin keluar?')) {
                stopValidationMonitoring();
                currentUser = null;
                localStorage.removeItem('pinuslo_user');
                
                // Reset all pages
                document.querySelectorAll('.page-section').forEach(function(s) { 
                    s.classList.remove('active'); 
                });
                document.getElementById('loginPage').classList.add('active');
                document.getElementById('loginForm').reset();
                
                showToast('Berhasil keluar', 'success');
            }
        }

        // ============================================
        // ABSENSI SYSTEM
        // ============================================
        async function loadAbsensi(user) {
            document.getElementById('appSelectionPage').classList.remove('active');
            document.getElementById('absensiPage').classList.add('active');
            
            // Show reports nav for admin
            if (user.role === 'admin') {
                document.getElementById('navReports').style.display = 'flex';
            }
            
            // Initialize map and location
            setTimeout(function() {
                initMap();
                getCurrentLocation()
                    .then(function() { 
                        return startValidationMonitoring(); 
                    })
                    .catch(function(err) {
                        console.error('Location error:', err);
                        showToast('Gagal mendapatkan lokasi. Aktifkan GPS Anda.', 'warning');
                    });
            }, 300);
            
            // Start clock
            updateClock();
            setInterval(updateClock, 1000);
            
            // Load today's attendance
            await loadTodayAttendance();
            
            // Load history
            await loadHistory(user.username);
        }

        function updateClock() {
            const now = new Date();
            const clockEl = document.getElementById('clock');
            const dateEl = document.getElementById('date');
            
            if (clockEl) {
                clockEl.textContent = now.toLocaleTimeString('id-ID');
            }
            
            if (dateEl) {
                dateEl.textContent = now.toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }
        }

        async function loadTodayAttendance() {
            const today = new Date().toISOString().split('T')[0];
            const todayData = await loadData(currentUser.username, today);
            
            const attendanceInfo = document.getElementById('attendanceInfo');
            
            if (todayData) {
                const totalHours = calculateWorkingHours(todayData.checkIn, todayData.checkOut);
                
                let html = '<div class="info-row"><div class="info-label"><i class="fas fa-sign-in-alt" style="color: #10b981;"></i>Check In</div><div class="info-value">' + (todayData.checkIn || '-') + '</div></div>';
                html += '<div class="info-row"><div class="info-label"><i class="fas fa-sign-out-alt" style="color: #ef4444;"></i>Check Out</div><div class="info-value">' + (todayData.checkOut || '-') + '</div></div>';
                
                if (todayData.distance) {
                    html += '<div class="info-row"><div class="info-label"><i class="fas fa-map-pin"></i>Jarak WiFi</div><div class="info-value">' + todayData.distance + 'm</div></div>';
                }
                
                if (todayData.checkOut) {
                    html += '<div class="info-row"><div class="info-label"><i class="fas fa-clock"></i>Total Jam Kerja</div><div class="info-value" style="color: #6e9726;">' + totalHours + '</div></div>';
                }
                
                attendanceInfo.innerHTML = html;
            } else {
                attendanceInfo.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-times"></i><p>Belum ada data absensi hari ini</p></div>';
            }
            
            validateAttendanceConditions();
        }

        function initMap() {
            if (map) map.remove();
            
            map = L.map('map').setView([GEOFENCE_CENTER.lat, GEOFENCE_CENTER.lon], 17);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            geofenceCircle = L.circle([GEOFENCE_CENTER.lat, GEOFENCE_CENTER.lon], {
                color: '#6e9726',
                fillColor: '#6e9726',
                fillOpacity: 0.2,
                radius: GEOFENCE_RADIUS,
                weight: 2
            }).addTo(map);
            
            geofenceCircle.bindPopup('<strong>' + LOCATIONS[selectedLocation].name + '</strong><br>Radius: ' + GEOFENCE_RADIUS + 'm');
            
            const centerIcon = L.divIcon({
                html: '<div style="background: #dc2626; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
                iconSize: [12, 12],
                className: ''
            });
            
            L.marker([GEOFENCE_CENTER.lat, GEOFENCE_CENTER.lon], { icon: centerIcon })
                .addTo(map)
                .bindPopup('<strong>📍 WiFi Center</strong>');
        }

        function getCurrentLocation() {
            return new Promise(function(resolve, reject) {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation tidak didukung'));
                    return;
                }
                
                const locationStatus = document.getElementById('locationStatus');
                if (locationStatus) {
                    locationStatus.className = 'status-item warning';
                    locationStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i><div class="status-content"><strong>Mendapatkan lokasi...</strong><small>Mohon tunggu</small></div>';
                }
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        updateUserLocation(lat, lon);
                        resolve({ lat: lat, lon: lon });
                    },
                    function(error) {
                        const locationStatus = document.getElementById('locationStatus');
                        if (locationStatus) {
                            locationStatus.className = 'status-item error';
                            locationStatus.innerHTML = '<i class="fas fa-times-circle"></i><div class="status-content"><strong>Gagal mendapatkan lokasi</strong><small>Aktifkan GPS Anda</small></div>';
                        }
                        reject(error);
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }

        function updateUserLocation(lat, lon) {
            currentLocation = { lat: lat, lon: lon };
            
            if (userMarker) map.removeLayer(userMarker);
            
            const distance = getDistance(lat, lon, GEOFENCE_CENTER.lat, GEOFENCE_CENTER.lon);
            const isInside = distance <= GEOFENCE_RADIUS;
            
            const icon = L.divIcon({
                html: '<div style="background: ' + (isInside ? '#10b981' : '#ef4444') + '; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>',
                iconSize: [16, 16],
                className: ''
            });
            
            userMarker = L.marker([lat, lon], { icon: icon }).addTo(map);
            userMarker.bindPopup('<strong>Lokasi Anda</strong><br>' + (isInside ? '✅ Di dalam area' : '❌ Di luar area') + '<br>Jarak: ' + Math.round(distance) + 'm');
            
            map.setView([lat, lon], 17);
            
            const locationStatus = document.getElementById('locationStatus');
            if (locationStatus) {
                if (isInside) {
                    locationStatus.className = 'status-item success';
                    locationStatus.innerHTML = '<i class="fas fa-check-circle"></i><div class="status-content"><strong>Lokasi Valid ✅</strong><small>Jarak: ' + Math.round(distance) + 'm dari WiFi</small></div>';
                } else {
                    locationStatus.className = 'status-item error';
                    locationStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i><div class="status-content"><strong>Lokasi Tidak Valid ❌</strong><small>Anda ' + Math.round(distance) + 'm dari area (max ' + GEOFENCE_RADIUS + 'm)</small></div>';
                }
            }
            
            updateWiFiStatus();
            validateAttendanceConditions();
        }

        async function updateWiFiStatus() {
            const wifiStatus = document.getElementById('wifiStatus');
            if (!wifiStatus) return;
            
            wifiStatus.className = 'status-item warning';
            wifiStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i><div class="status-content"><strong>Memeriksa WiFi...</strong><small>Mohon tunggu</small></div>';
            
            const wifiCheck = await checkWiFiConnection();
            
            if (wifiCheck.connected) {
                wifiStatus.className = 'status-item success';
                wifiStatus.innerHTML = '<i class="fas fa-wifi"></i><div class="status-content"><strong>WiFi Terhubung ✅</strong><small>' + REQUIRED_WIFI.ssid + '</small></div>';
            } else {
                wifiStatus.className = 'status-item error';
                wifiStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i><div class="status-content"><strong>WiFi Tidak Terhubung ❌</strong><small>' + wifiCheck.reason + '</small></div>';
            }
        }

        async function checkWiFiConnection() {
            if (!navigator.onLine) {
                return { connected: false, reason: 'Tidak terhubung internet' };
            }
            
            if (currentLocation) {
                const distance = getDistance(
                    currentLocation.lat, 
                    currentLocation.lon, 
                    GEOFENCE_CENTER.lat, 
                    GEOFENCE_CENTER.lon
                );
                
                if (distance <= GEOFENCE_RADIUS) {
                    return { 
                        connected: true, 
                        reason: 'Terkoneksi di area WiFi',
                        distance: Math.round(distance)
                    };
                } else {
                    return { 
                        connected: false, 
                        reason: 'Terlalu jauh (' + Math.round(distance) + 'm)',
                        distance: Math.round(distance)
                    };
                }
            }
            
            return { connected: false, reason: 'Lokasi belum terdeteksi' };
        }

        async function validateAttendanceConditions() {
            const wifiCheck = await checkWiFiConnection();
            const locationValid = currentLocation && isInGeofence(currentLocation.lat, currentLocation.lon);
            isValidForAttendance = wifiCheck.connected && locationValid;
            
            updateButtonStates();
            return isValidForAttendance;
        }

        async function updateButtonStates() {
            const checkInBtn = document.getElementById('checkInBtn');
            const checkOutBtn = document.getElementById('checkOutBtn');
            
            if (!checkInBtn || !checkOutBtn) return;
            
            const today = new Date().toISOString().split('T')[0];
            const todayData = await loadData(currentUser.username, today);
            
            const isIn = todayData && todayData.checkIn && !todayData.checkOut;
            const isDone = todayData && todayData.checkOut;
            
            // Check In button
            if (!isValidForAttendance || isIn || isDone) {
                checkInBtn.disabled = true;
            } else {
                checkInBtn.disabled = false;
            }
            
            // Check Out button
            if (!isValidForAttendance || !isIn || isDone) {
                checkOutBtn.disabled = true;
            } else {
                checkOutBtn.disabled = false;
            }
        }

        function startValidationMonitoring() {
            if (validationInterval) clearInterval(validationInterval);
            validateAttendanceConditions();
            validationInterval = setInterval(function() { 
                return validateAttendanceConditions(); 
            }, 5000);
        }

        function stopValidationMonitoring() {
            if (validationInterval) {
                clearInterval(validationInterval);
                validationInterval = null;
            }
        }

        function refreshLocation() {
            getCurrentLocation()
                .then(function() {
                    showToast('✅ Lokasi diperbarui!', 'success');
                    validateAttendanceConditions();
                })
                .catch(function(err) { 
                    return showToast('Gagal: ' + err.message, 'error'); 
                });
        }

        function switchLocation(locationKey) {
            selectedLocation = locationKey;
            GEOFENCE_CENTER = LOCATIONS[locationKey].center;
            GEOFENCE_RADIUS = LOCATIONS[locationKey].radius;
            REQUIRED_WIFI = LOCATIONS[locationKey].wifi;
            
            // Update UI
            document.querySelectorAll('.location-btn').forEach(function(btn) {
                btn.classList.remove('active');
            });
            document.getElementById('locBtn_' + locationKey).classList.add('active');
            
            // Re-initialize map
            if (map) {
                map.remove();
                map = null;
            }
            initMap();
            
            getCurrentLocation()
                .then(function() {
                    validateAttendanceConditions();
                    showToast('✅ Beralih ke ' + LOCATIONS[locationKey].name, 'success');
                })
                .catch(function(err) { 
                    return console.error('Location error:', err); 
                });
        }

        async function checkIn() {
            const isValid = await validateAttendanceConditions();
            if (!isValid) {
                showToast('❌ WiFi dan lokasi harus valid!', 'error');
                return;
            }
            
            const distance = getDistance(
                currentLocation.lat, 
                currentLocation.lon, 
                GEOFENCE_CENTER.lat, 
                GEOFENCE_CENTER.lon
            );
            
            const now = new Date();
            const date = now.toISOString().split('T')[0];
            const time = now.toLocaleTimeString('id-ID');
            
            const data = {
                username: currentUser.username,
                fullName: currentUser.fullName,
                date: date,
                checkIn: time,
                checkOut: null,
                approved: false,
                location: currentLocation,
                distance: Math.round(distance),
                locationName: LOCATIONS[selectedLocation].name,
                wifiSSID: REQUIRED_WIFI.ssid
            };
            
            if (window.firebaseEnabled && window.firebaseDb) {
                try {
                    const modules = window.firebaseModules;
                    const docData = Object.assign({}, data, { timestamp: new Date() });
                    await modules.setDoc(
                        modules.doc(window.firebaseDb, 'attendance', currentUser.username + '_' + date),
                        docData
                    );
                    showToast('✅ Check In berhasil!', 'success');
                } catch (e) {
                    console.error('Firebase error:', e);
                    saveLocal(data);
                    showToast('✅ Check In berhasil! (Local)', 'success');
                }
            } else {
                saveLocal(data);
                showToast('✅ Check In berhasil! (Local)', 'success');
            }
            
            setTimeout(function() { 
                return loadTodayAttendance(); 
            }, 500);
        }

        async function checkOut() {
            const isValid = await validateAttendanceConditions();
            if (!isValid) {
                showToast('❌ WiFi dan lokasi harus valid!', 'error');
                return;
            }
            
            const distance = getDistance(
                currentLocation.lat,
                currentLocation.lon,
                GEOFENCE_CENTER.lat,
                GEOFENCE_CENTER.lon
            );
            
            const now = new Date();
            const date = now.toISOString().split('T')[0];
            const time = now.toLocaleTimeString('id-ID');
            
            if (window.firebaseEnabled && window.firebaseDb) {
                try {
                    const modules = window.firebaseModules;
                    await modules.updateDoc(
                        modules.doc(window.firebaseDb, 'attendance', currentUser.username + '_' + date),
                        {
                            checkOut: time,
                            checkOutTimestamp: new Date(),
                            checkOutLocation: currentLocation,
                            checkOutDistance: Math.round(distance),
                            checkOutLocationName: LOCATIONS[selectedLocation].name,
                            checkOutWifiSSID: REQUIRED_WIFI.ssid
                        }
                    );
                    showToast('✅ Check Out berhasil!', 'success');
                } catch (e) {
                    console.error('Firebase error:', e);
                    updateLocal(date, time, distance);
                    showToast('✅ Check Out berhasil! (Local)', 'success');
                }
            } else {
                updateLocal(date, time, distance);
                showToast('✅ Check Out berhasil! (Local)', 'success');
            }
            
            setTimeout(function() {
                loadTodayAttendance();
                loadHistory(currentUser.username);
            }, 500);
        }

        function saveLocal(data) {
            const local = JSON.parse(localStorage.getItem('attendance_' + currentUser.username) || '{}');
            local[data.date] = data;
            localStorage.setItem('attendance_' + currentUser.username, JSON.stringify(local));
        }

        function updateLocal(date, time, distance) {
            const local = JSON.parse(localStorage.getItem('attendance_' + currentUser.username) || '{}');
            if (local[date]) {
                local[date].checkOut = time;
                local[date].checkOutLocation = currentLocation;
                local[date].checkOutDistance = Math.round(distance);
                localStorage.setItem('attendance_' + currentUser.username, JSON.stringify(local));
            }
        }

        async function loadData(username, date) {
            if (window.firebaseEnabled && window.firebaseDb) {
                try {
                    const modules = window.firebaseModules;
                    const docSnap = await modules.getDoc(
                        modules.doc(window.firebaseDb, 'attendance', username + '_' + date)
                    );
                    return docSnap.exists() ? docSnap.data() : null;
                } catch (e) {
                    console.log('Firebase error:', e);
                }
            }
            
            const local = JSON.parse(localStorage.getItem('attendance_' + username) || '{}');
            return local[date] || null;
        }

        async function loadHistory(username, limitCount) {
            if (limitCount === void 0) { limitCount = 30; }
            
            let data = {};
            
            if (window.firebaseEnabled && window.firebaseDb) {
                try {
                    const modules = window.firebaseModules;
                    const q = modules.query(
                        modules.collection(window.firebaseDb, 'attendance'),
                        modules.where('username', '==', username),
                        modules.orderBy('date', 'desc'),
                        modules.limit(limitCount)
                    );
                    const snap = await modules.getDocs(q);
                    snap.forEach(function(doc) {
                        const d = doc.data();
                        data[d.date] = d;
                    });
                } catch (e) {
                    console.log('Firebase error:', e);
                }
            }
            
            if (Object.keys(data).length === 0) {
                data = JSON.parse(localStorage.getItem('attendance_' + username) || '{}');
            }
            
            const historyList = document.getElementById('historyList');
            if (!historyList) return;
            
            if (Object.keys(data).length === 0) {
                historyList.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-times"></i><p>Belum ada riwayat absensi</p></div>';
                return;
            }
            
            const dates = Object.keys(data).sort().reverse().slice(0, limitCount);
            
            historyList.innerHTML = dates.map(function(date) {
                const d = data[date];
                const dateObj = new Date(date + 'T00:00:00');
                const formatted = dateObj.toLocaleDateString('id-ID', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                const workHours = calculateWorkingHours(d.checkIn, d.checkOut);
                
                let statusBadge = '';
                if (d.rejected) {
                    statusBadge = '<span class="status-badge status-rejected">Ditolak</span>';
                } else if (d.approved) {
                    statusBadge = '<span class="status-badge status-approved">Disetujui</span>';
                } else if (d.checkOut) {
                    statusBadge = '<span class="status-badge status-pending">Menunggu</span>';
                } else {
                    statusBadge = '<span class="status-badge status-incomplete">Belum Selesai</span>';
                }
                
                let html = '<div class="history-item"><div class="history-date">' + formatted + '</div><div class="history-times"><div class="time-badge in"><i class="fas fa-sign-in-alt"></i><span>' + (d.checkIn || '-') + '</span></div><div class="time-badge out"><i class="fas fa-sign-out-alt"></i><span>' + (d.checkOut || '-') + '</span></div></div><div class="history-meta"><span><i class="fas fa-clock"></i> ' + workHours + '</span>' + statusBadge + '</div>';
                
                if (d.rejected && d.rejectionReason) {
                    html += '<div class="rejection-reason"><strong>Alasan:</strong> ' + d.rejectionReason + '</div>';
                }
                
                html += '</div>';
                return html;
            }).join('');
        }

        function switchAbsensiView(view) {
            if (view === 'check') {
                document.getElementById('absensiPage').classList.add('active');
                document.getElementById('reportsPage').classList.remove('active');
            } else if (view === 'history') {
                const historyEl = document.querySelector('.history-list');
                if (historyEl) {
                    historyEl.scrollIntoView({ behavior: 'smooth' });
                }
            } else if (view === 'reports' && currentUser.role === 'admin') {
                document.getElementById('absensiPage').classList.remove('active');
                document.getElementById('reportsPage').classList.add('active');
                
                // Set today's date
                document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
                loadReports();
            }
        }

        function backToSelection() {
            stopValidationMonitoring();
            document.getElementById('absensiPage').classList.remove('active');
            document.getElementById('reportsPage').classList.remove('active');
            document.getElementById('appSelectionPage').classList.add('active');
            
            if (map) {
                map.remove();
                map = null;
            }
        }

        function backToAbsensi() {
            document.getElementById('reportsPage').classList.remove('active');
            document.getElementById('absensiPage').classList.add('active');
        }

        // ============================================
        // REPORTS (ADMIN)
        // ============================================
        async function loadReports() {
            const reportType = document.getElementById('reportType').value;
            const reportDate = new Date(document.getElementById('reportDate').value);
            
            let allData = {};
            for (const user of allUsers.filter(function(u) { 
                return u.apps.includes('absensi'); 
            })) {
                const userData = await loadAllUserData(user.username);
                Object.assign(allData, userData);
            }
            
            let filteredData = [];
            const dates = Object.keys(allData).sort().reverse();
            
            if (reportType === 'daily') {
                const targetDate = reportDate.toISOString().split('T')[0];
                filteredData = dates
                    .filter(function(d) { return d === targetDate; })
                    .map(function(d) { return allData[d]; });
            } else if (reportType === 'weekly') {
                const weekStart = new Date(reportDate);
                weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                filteredData = dates
                    .filter(function(d) {
                        const date = new Date(d);
                        return date >= weekStart && date <= weekEnd;
                    })
                    .map(function(d) { return allData[d]; });
            } else if (reportType === 'monthly') {
                const month = reportDate.getMonth();
                const year = reportDate.getFullYear();
                filteredData = dates
                    .filter(function(d) {
                        const date = new Date(d);
                        return date.getMonth() === month && date.getFullYear() === year;
                    })
                    .map(function(d) { return allData[d]; });
            }
            
            const reportsList = document.getElementById('reportsList');
            
            if (filteredData.length === 0) {
                reportsList.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><p>Tidak ada data untuk periode ini</p></div>';
                return;
            }
            
            reportsList.innerHTML = filteredData.map(function(data) {
                const date = new Date(data.date);
                const formattedDate = date.toLocaleDateString('id-ID', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                
                const totalHours = calculateWorkingHours(data.checkIn, data.checkOut);
                
                let status = 'incomplete';
                let statusText = 'Belum Selesai';
                
                if (data.checkOut) {
                    if (data.rejected) {
                        status = 'rejected';
                        statusText = 'Ditolak';
                    } else if (data.approved) {
                        status = 'approved';
                        statusText = 'Disetujui';
                    } else {
                        status = 'pending';
                        statusText = 'Menunggu';
                    }
                }
                
                const canTakeAction = data.checkOut && !data.approved && !data.rejected;
                
                let html = '<div class="report-item"><div class="report-header"><div class="report-user"><h4>' + data.fullName + '</h4><p>' + formattedDate + '</p></div><span class="status-badge status-' + status + '">' + statusText + '</span></div><div class="report-details"><div class="detail-item"><span class="detail-label">Check In</span><span class="detail-value">' + (data.checkIn || '-') + '</span></div><div class="detail-item"><span class="detail-label">Check Out</span><span class="detail-value">' + (data.checkOut || '-') + '</span></div><div class="detail-item"><span class="detail-label">Jarak WiFi</span><span class="detail-value">' + (data.distance ? data.distance + 'm' : '-') + '</span></div><div class="detail-item"><span class="detail-label">Total Jam</span><span class="detail-value">' + totalHours + '</span></div></div>';
                
                if (data.rejected && data.rejectionReason) {
                    html += '<div class="rejection-reason"><strong>Alasan Penolakan:</strong> ' + data.rejectionReason + '</div>';
                }
                
                html += '<div class="report-actions"><button class="btn-approve" onclick="approveAttendance(\'' + data.username + '\', \'' + data.date + '\')" ' + (!canTakeAction ? 'disabled' : '') + '><i class="fas fa-check"></i>Setujui</button><button class="btn-reject" onclick="openRejectModal(\'' + data.username + '\', \'' + data.date + '\', \'' + data.fullName + '\')" ' + (!canTakeAction ? 'disabled' : '') + '><i class="fas fa-times"></i>Tolak</button></div></div>';
                
                return html;
            }).join('');
        }

        async function loadAllUserData(username) {
            let data = {};
            
            if (window.firebaseEnabled && window.firebaseDb) {
                try {
                    const modules = window.firebaseModules;
                    const q = modules.query(
                        modules.collection(window.firebaseDb, 'attendance'),
                        modules.where('username', '==', username)
                    );
                    const snap = await modules.getDocs(q);
                    snap.forEach(function(doc) {
                        const d = doc.data();
                        data[d.date] = d;
                    });
                } catch (e) {
                    console.log('Firebase error:', e);
                }
            }
            
            if (Object.keys(data).length === 0) {
                data = JSON.parse(localStorage.getItem('attendance_' + username) || '{}');
            }
            
            return data;
        }

        async function approveAttendance(username, date) {
            if (window.firebaseEnabled && window.firebaseDb) {
                try {
                    const modules = window.firebaseModules;
                    await modules.updateDoc(
                        modules.doc(window.firebaseDb, 'attendance', username + '_' + date),
                        {
                            approved: true,
                            approvedBy: currentUser.fullName,
                            approvedAt: new Date().toISOString()
                        }
                    );
                    showToast('✅ Absensi disetujui!', 'success');
                } catch (e) {
                    console.log('Firebase error, using local');
                    approveLocal(username, date);
                    showToast('✅ Absensi disetujui! (Local)', 'success');
                }
            } else {
                approveLocal(username, date);
                showToast('✅ Absensi disetujui! (Local)', 'success');
            }
            
            setTimeout(function() { 
                return loadReports(); 
            }, 500);
        }

        function approveLocal(username, date) {
            const local = JSON.parse(localStorage.getItem('attendance_' + username) || '{}');
            if (local[date]) {
                local[date].approved = true;
                local[date].approvedBy = currentUser.fullName;
                local[date].approvedAt = new Date().toISOString();
                localStorage.setItem('attendance_' + username, JSON.stringify(local));
            }
        }

        function openRejectModal(username, date, fullName) {
            currentRejectData = { username: username, date: date, fullName: fullName };
            
            document.getElementById('rejectModalUser').textContent = fullName + ' - ' + date;
            document.getElementById('rejectionReason').value = '';
            
            document.getElementById('rejectModal').classList.add('active');
            
            setTimeout(function() {
                document.getElementById('rejectionReason').focus();
            }, 300);
        }

        function closeRejectModal() {
            document.getElementById('rejectModal').classList.remove('active');
            currentRejectData = null;
            document.getElementById('rejectionReason').value = '';
        }

        async function confirmRejectAttendance() {
            if (!currentRejectData) {
                showToast('❌ Data tidak valid!', 'error');
                return;
            }
            
            const reason = document.getElementById('rejectionReason').value.trim();
            
            if (!reason) {
                showToast('❌ Alasan penolakan harus diisi!', 'error');
                return;
            }
            
            if (reason.length < 10) {
                showToast('❌ Alasan minimal 10 karakter!', 'error');
                return;
            }
            
            const username = currentRejectData.username;
            const date = currentRejectData.date;
            const fullName = currentRejectData.fullName;
            
            if (!confirm('Yakin menolak absensi ' + fullName + '?')) {
                return;
            }
            
            if (window.firebaseEnabled && window.firebaseDb) {
                try {
                    const modules = window.firebaseModules;
                    await modules.updateDoc(
                        modules.doc(window.firebaseDb, 'attendance', username + '_' + date),
                        {
                            rejected: true,
                            approved: false,
                            rejectionReason: reason,
                            rejectedBy: currentUser.fullName,
                            rejectedAt: new Date().toISOString()
                        }
                    );
                    showToast('✅ Absensi ditolak!', 'success');
                } catch (e) {
                    console.log('Firebase error, using local');
                    rejectLocal(username, date, reason);
                    showToast('✅ Absensi ditolak! (Local)', 'success');
                }
            } else {
                rejectLocal(username, date, reason);
                showToast('✅ Absensi ditolak! (Local)', 'success');
            }
            
            closeRejectModal();
            setTimeout(function() { 
                return loadReports(); 
            }, 500);
        }

        function rejectLocal(username, date, reason) {
            const local = JSON.parse(localStorage.getItem('attendance_' + username) || '{}');
            if (local[date]) {
                local[date].rejected = true;
                local[date].approved = false;
                local[date].rejectionReason = reason;
                local[date].rejectedBy = currentUser.fullName;
                local[date].rejectedAt = new Date().toISOString();
                localStorage.setItem('attendance_' + username, JSON.stringify(local));
            }
        }

        function exportReport() {
            const reportType = document.getElementById('reportType').value;
            const reportDate = document.getElementById('reportDate').value;
            
            const filename = 'Laporan_Absensi_' + reportType + '_' + reportDate + '.csv';
            
            const reportsList = document.getElementById('reportsList');
            if (!reportsList || reportsList.children.length === 0) {
                showToast('Tidak ada data untuk diekspor', 'error');
                return;
            }
            
            let csv = 'Nama,Tanggal,Check In,Check Out,Total Jam,Jarak WiFi,Status\n';
            
            const items = reportsList.querySelectorAll('.report-item');
            items.forEach(function(item) {
                const name = item.querySelector('.report-user h4').textContent;
                const date = item.querySelector('.report-user p').textContent;
                const details = item.querySelectorAll('.detail-value');
                const checkIn = details[0].textContent;
                const checkOut = details[1].textContent;
                const distance = details[2].textContent;
                const totalHours = details[3].textContent;
                const status = item.querySelector('.status-badge').textContent;
                
                csv += '"' + name + '","' + date + '","' + checkIn + '","' + checkOut + '","' + totalHours + '","' + distance + '","' + status + '"\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            
            showToast('✅ Report berhasil diexport!', 'success');
        }

        // ============================================
        // MODAL EVENT HANDLERS
        // ============================================
        const rejectModal = document.getElementById('rejectModal');
        if (rejectModal) {
            rejectModal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeRejectModal();
                }
            });
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        window.addEventListener('load', function() {
            setTimeout(function() {
                const saved = localStorage.getItem('pinuslo_user');
                if (saved) {
                    const user = JSON.parse(saved);
                    currentUser = user;
                    showAppSelection(user);
                }
                
                console.log('🚀 Pinuslo Apps - Mobile Optimized');
                console.log(window.firebaseEnabled ? '✅ Firebase Connected' : '⚠️ Firebase Offline');
            }, 500);
        });

        // Prevent pull-to-refresh on iOS
        document.body.addEventListener('touchmove', function(e) {
            if (e.target.closest('.modal-sheet') || e.target.closest('#map')) {
                return;
            }
            if (document.body.scrollTop === 0) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>
